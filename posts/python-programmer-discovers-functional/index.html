<!DOCTYPE html>
<html lang="en-gb">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#98AFC7">
	<meta name="msapplication-TileColor" content="#98AFC7">
<meta itemprop="name" content="Python Programmer Discovers Functional Programming. World Keeps Turning">
<meta itemprop="description" content="Handling time series data using python’s builtin datastructures is a bitch. I guess the best way would be to just use a library like pandas, but a colleague came across the way I’d handled it in this code snippet using itertools and functools and asked me to share it with the rest of the team.  I’ll just concentrate on the parts which require more explanation. The most complex line to understand is line 24">


<meta itemprop="datePublished" content="2011-09-23T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2011-09-23T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="460">



<meta itemprop="keywords" content="python,timeseries data," />
<meta property="og:title" content="Python Programmer Discovers Functional Programming. World Keeps Turning" />
<meta property="og:description" content="Handling time series data using python’s builtin datastructures is a bitch. I guess the best way would be to just use a library like pandas, but a colleague came across the way I’d handled it in this code snippet using itertools and functools and asked me to share it with the rest of the team.  I’ll just concentrate on the parts which require more explanation. The most complex line to understand is line 24" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://the.chuntering.dev/posts/python-programmer-discovers-functional/" /><meta property="article:published_time" content="2011-09-23T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2011-09-23T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python Programmer Discovers Functional Programming. World Keeps Turning"/>
<meta name="twitter:description" content="Handling time series data using python’s builtin datastructures is a bitch. I guess the best way would be to just use a library like pandas, but a colleague came across the way I’d handled it in this code snippet using itertools and functools and asked me to share it with the rest of the team.  I’ll just concentrate on the parts which require more explanation. The most complex line to understand is line 24"/>
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Python Programmer Discovers Functional Programming. World Keeps Turning</title>
	<link rel="stylesheet" href="https://the.chuntering.dev/css/style.min.9a30741782203507f3d35fe9cefabad487c72fc82dfbdf59121759fc2fa52f92.css" integrity="sha256-mjB0F4IgNQfz01/pzvq61IfHL8gt+99ZEhdZ/C+lL5I=">
	
	<link rel="stylesheet" href="https://the.chuntering.dev/css/code.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://the.chuntering.dev">Joe T</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://the.chuntering.dev/posts/">Posts</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/mythral_mystic" target="_blank" rel="noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/joetsoi" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://the.chuntering.dev/posts/">Posts</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Sep 23, 2011</span></div>
				<h1>Python Programmer Discovers Functional Programming. World Keeps Turning</h1>
			</header>
			<div class="content">
				

<p>Handling time series data using python’s builtin datastructures is a bitch. I guess the best way would be to just use a library like <code>pandas</code>, but a colleague came across the way I’d handled it in this code snippet using itertools and functools and asked me to share it with the rest of the team.
<script type="application/javascript" src="//gist.github.com/joetsoi/1235081.js"></script>
I’ll just concentrate on the parts which require more explanation. The most complex line to understand is line 24</p>

<h2 id="list-comprehensions-and-python-switch">List comprehensions and python ‘switch’</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">row</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span> <span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">function_dict</span><span class="p">[</span><span class="n">option</span><span class="p">](</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;list&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">table_options</span> <span class="p">])</span>  </code></pre></div>
<p>The dict function can build dictionaries in a variety of ways, a list pairs in my case, that I build using a list comprehension. The second element of each pair is built by calling a function from a dictionary of functions. This is my prefered way of emulating the switch statement in python, with each option in table_option acting as each individual ‘case’ statement selector.</p>

<p>One of the guys here prefers a series of ‘if/else’s but I prefer the one hash lookup to possibly evaluating every single if condition. It also can start to look ugly and python’s if/else doesn’t declare a new scope.</p>

<h2 id="itertools-takewhile-dropwhile">itertools : takewhile, dropwhile</h2>

<p>Each function in the hopefully obviously named function_dict is a simple function that calculates the day/week/month change or year high/low. The week and month calculation are quite fun, it’s just the difference between two prices, but the second price is calculated by iterating over the series using <code>dropwhile</code> until the condition <code>is_same_month</code> met. Then getting the next element. This avoids iterating over the whole series whilst avoiding problems of sparse weeks (bank holidays or royal weddings for example).
The year lambda function takes the low and high from the series where they are in the same year. Notice how similar that sentence is to the actual function</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">lambda</span> <span class="n">series</span><span class="p">:</span> <span class="n">low_high</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">price</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">takewhile</span><span class="p">(</span><span class="n">is_same_year</span><span class="p">,</span> <span class="n">series</span><span class="p">))</span>  </code></pre></div>
<p>I guess that’s why I like things like <code>takewhile</code>.
<code>low_high</code> is just a wrapper around the builtin <code>min</code> and <code>max</code>.</p>

<h2 id="partial-application-in-functools">Partial application in functools</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">is_same_month</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="k">lambda</span> <span class="n">date</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">datestamp</span> <span class="o">&lt;</span> <span class="n">date</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>  </code></pre></div>
<p>The functions <code>is_same_week</code>/<code>is_same_month</code> are partially applied lambda functions. Lambda functions can’t take variables from the surrounding scope so we use partial from functools to partially apply the function and fill the parameter with date from the django template context so we can fix the ‘same date’ to a specific one.</p>

<h3 id="readability">Readability</h3>

<p>If you’ve dabbled with functional programming, like I’ve tried to you should be quite happy with these concepts. Another thing to note is I used a plain for loop when iterating over <code>series_set</code>. I’ve tried refactoring it into a list comprehension, but I didn’t want to end up with a nested listed comprehension and readibilty won out. Also List comprehensions <a href="http://python-history.blogspot.com/2010/06/from-list-comprehensions-to-generator.html" target="_blank">‘leak’ variables</a>.</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://the.chuntering.dev/tags/python">python</a></span><span class="tag"><a href="https://the.chuntering.dev/tags/timeseries-data">timeseries data</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>460 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2011-09-23 01:00 &#43;0100</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://the.chuntering.dev/posts/ckan-sqlalchemy-and-detached-instance-errors/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>CKAN Sqlalchemy and Detached Instance Errors</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://the.chuntering.dev">Joe</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://the.chuntering.dev/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://the.chuntering.dev/js/main.min.8f39f24808e9d0a9b02da58c2d2838da859dc0b7bdfadbdb1883aae8b6adacfe.js" integrity="sha256-jznySAjp0KmwLaWMLSg42oWdwLe9+tvbGIOq6LatrP4="></script>

</body>

</html>
