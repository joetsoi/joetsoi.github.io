<!DOCTYPE html>
<html lang="en-gb">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#98AFC7">
	<meta name="msapplication-TileColor" content="#98AFC7">
<meta itemprop="name" content="Digging into python memory issues in ckan with heapy">
<meta itemprop="description" content="So we had a report about a memory leak when using the ckan datastore extension, where large queries to the datastore would leak large amounts of memory per request. It wasn&#39;t simple to get to the bottom of it, at first I couldn&#39;t recreate it the leak at all. The test data I was using was the STAR experiment csv files, which I found when I googled &lsquo;Large example csv files&rsquo;.">
<meta itemprop="datePublished" content="2015-06-01T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2015-06-01T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2255">



<meta itemprop="keywords" content="ckan,debugging,python,heapy," /><meta property="og:title" content="Digging into python memory issues in ckan with heapy" />
<meta property="og:description" content="So we had a report about a memory leak when using the ckan datastore extension, where large queries to the datastore would leak large amounts of memory per request. It wasn&#39;t simple to get to the bottom of it, at first I couldn&#39;t recreate it the leak at all. The test data I was using was the STAR experiment csv files, which I found when I googled &lsquo;Large example csv files&rsquo;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://the.chuntering.dev/posts/debugging-python-ckan-memory-issues/" />
<meta property="article:published_time" content="2015-06-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-06-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Digging into python memory issues in ckan with heapy"/>
<meta name="twitter:description" content="So we had a report about a memory leak when using the ckan datastore extension, where large queries to the datastore would leak large amounts of memory per request. It wasn&#39;t simple to get to the bottom of it, at first I couldn&#39;t recreate it the leak at all. The test data I was using was the STAR experiment csv files, which I found when I googled &lsquo;Large example csv files&rsquo;."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Digging into python memory issues in ckan with heapy</title>
	<link rel="stylesheet" href="https://the.chuntering.dev/css/style.min.657bcb7af31123e4156b1a3d2ff60a636717e54ead74f882136b5114cf72b55e.css" integrity="sha256-ZXvLevMRI+QVaxo9L/YKY2cX5U6tdPiCE2tRFM9ytV4=" crossorigin="anonymous">
	
	<link rel="stylesheet" href="https://the.chuntering.dev/css/code.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://the.chuntering.dev">Joe T</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://the.chuntering.dev/posts/">Posts</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/mythral_mystic" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/joetsoi" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://the.chuntering.dev/posts/">Posts</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jun 1, 2015</span></div>
				<h1>Digging into python memory issues in ckan with heapy</h1>
			</header>
			<div class="content">
				<p>So we had a report about a memory leak when using the ckan datastore extension, where large queries to the datastore would leak large amounts of memory per request. It wasn't simple to get to the bottom of it, at first I couldn't recreate it the leak at all. The test data I was using was the <a href="https://sdm.lbl.gov/fastbit/data/samples.html">STAR experiment</a> csv files, which I found when I googled &lsquo;Large example csv files&rsquo;. The reporter Alice Heaton, had kindly written a script that would recreate the leak. Even with this, I could not recreate the problem, until I upped the number of rows fetched by a factor of ten. I suspect that Alice has more data per column with perhaps large text fields instead of the mainly numeric data of the STAR experiment data I was using.</p>
<p>Once I could reliably recreate the problem, I ended up poking around using <a href="http://guppy-pe.sourceforge.net/">heapy</a>, which I've used previously to track down similar problems and inserted some code to setup heapy and an ipdb breakpoint.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">guppy</span> <span class="kn">import</span> <span class="n">hpy</span>
<span class="n">hp</span> <span class="o">=</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span>
<span class="n">heap</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">heap</span><span class="p">(</span><span class="p">)</span>
<span class="n">strings</span> <span class="o">=</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="p">)</span>
</code></pre></div><p>before the <a href="https://github.com/ckan/ckan/blob/release-v2.3/ckan/controllers/api.py#L248">controller returns the result from the api.</a></p>
<p>There are some tutorials hanging around for <a href="http://smira.ru/wp-content/uploads/2011/08/heapy.html">heapy</a>, so I won't repeat the detail, but It looked like the previous responses were hanging around in memory and they were the root cause of the problem.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">heap</span><span class="o">.</span><span class="n">byrcs</span>  
 <span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">343689</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">266893568</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span> <span class="n">Count</span>  <span class="o">%</span>   <span class="n">Size</span>  <span class="o">%</span> <span class="n">Cumulative</span> <span class="o">%</span> <span class="n">Referrers</span> <span class="n">by</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/</span><span class="err"> </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>  
    <span class="mi">0</span>   <span class="mi">19</span>  <span class="mi">0</span> <span class="mi">190780624</span> <span class="mi">71</span> <span class="mi">190780624</span> <span class="mi">71</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span>  
    <span class="mi">1</span>   <span class="mi">11</span>  <span class="mi">0</span> <span class="mi">21199320</span>  <span class="mi">8</span> <span class="mi">211979944</span> <span class="mi">79</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span><span class="p">,</span> <span class="nb">list</span>  
    <span class="mi">2</span> <span class="mi">107194</span> <span class="mi">31</span> <span class="mi">10007816</span>  <span class="mi">4</span> <span class="mi">221987760</span> <span class="mi">83</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span>  
    <span class="mi">3</span> <span class="mi">41823</span> <span class="mi">12</span> <span class="mi">4018400</span>  <span class="mi">2</span> <span class="mi">226006160</span> <span class="mi">85</span> <span class="nb">tuple</span>  
    <span class="mi">4</span> <span class="mi">24904</span>  <span class="mi">7</span> <span class="mi">3071408</span>  <span class="mi">1</span> <span class="mi">229077568</span> <span class="mi">86</span> <span class="n">function</span>  
    <span class="mi">5</span>  <span class="mi">9287</span>  <span class="mi">3</span> <span class="mi">2350432</span>  <span class="mi">1</span> <span class="mi">231428000</span> <span class="mi">87</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">module</span>  
    <span class="mi">6</span>  <span class="mi">6440</span>  <span class="mi">2</span> <span class="mi">2324560</span>  <span class="mi">1</span> <span class="mi">233752560</span> <span class="mi">88</span> <span class="n">function</span><span class="p">,</span> <span class="nb">tuple</span>  
    <span class="mi">7</span>  <span class="mi">7144</span>  <span class="mi">2</span> <span class="mi">2229040</span>  <span class="mi">1</span> <span class="mi">235981600</span> <span class="mi">88</span> <span class="nb">type</span>  
    <span class="mi">8</span> <span class="mi">15536</span>  <span class="mi">5</span> <span class="mi">1949840</span>  <span class="mi">1</span> <span class="mi">237931440</span> <span class="mi">89</span> <span class="nb">dict</span> <span class="n">of</span> <span class="nb">type</span>  
    <span class="mi">9</span> <span class="mi">19440</span>  <span class="mi">6</span> <span class="mi">1858816</span>  <span class="mi">1</span> <span class="mi">239790256</span> <span class="mi">90</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>  
 <span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">343689</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">266892800</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span> <span class="n">Count</span>  <span class="o">%</span>   <span class="n">Size</span>  <span class="o">%</span> <span class="n">Cumulative</span> <span class="o">%</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/</span><span class="err"> </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">137776</span> <span class="mi">40</span> <span class="mi">225205640</span> <span class="mi">84</span> <span class="mi">225205640</span> <span class="mi">84</span> <span class="nb">str</span>  
    <span class="mi">1</span> <span class="mi">83479</span> <span class="mi">24</span> <span class="mi">7054200</span>  <span class="mi">3</span> <span class="mi">232259840</span> <span class="mi">87</span> <span class="nb">tuple</span>  
    <span class="mi">2</span>  <span class="mi">8486</span>  <span class="mi">2</span> <span class="mi">4350608</span>  <span class="mi">2</span> <span class="mi">236610448</span> <span class="mi">89</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>  
    <span class="mi">3</span> <span class="mi">18988</span>  <span class="mi">6</span> <span class="mi">2430464</span>  <span class="mi">1</span> <span class="mi">239040912</span> <span class="mi">90</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span>  
    <span class="mi">4</span> <span class="mi">19980</span>  <span class="mi">6</span> <span class="mi">2397600</span>  <span class="mi">1</span> <span class="mi">241438512</span> <span class="mi">90</span> <span class="n">function</span>  
    <span class="mi">5</span>  <span class="mi">842</span>  <span class="mi">0</span> <span class="mi">2387696</span>  <span class="mi">1</span> <span class="mi">243826208</span> <span class="mi">91</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">module</span>  
    <span class="mi">6</span>  <span class="mi">2190</span>  <span class="mi">1</span> <span class="mi">1984280</span>  <span class="mi">1</span> <span class="mi">245810488</span> <span class="mi">92</span> <span class="nb">type</span>  
    <span class="mi">7</span>  <span class="mi">2190</span>  <span class="mi">1</span> <span class="mi">1815888</span>  <span class="mi">1</span> <span class="mi">247626376</span> <span class="mi">93</span> <span class="nb">dict</span> <span class="n">of</span> <span class="nb">type</span>  
    <span class="mi">8</span>  <span class="mi">9956</span>  <span class="mi">3</span> <span class="mi">1585184</span>  <span class="mi">1</span> <span class="mi">249211560</span> <span class="mi">93</span> <span class="nb">list</span>  
    <span class="mi">9</span>  <span class="mi">2563</span>  <span class="mi">1</span> <span class="mi">1509984</span>  <span class="mi">1</span> <span class="mi">250721544</span> <span class="mi">94</span> <span class="nb">unicode</span>  
</code></pre></div><p>By inspecting those response strings using byid I could see that specifically the response strings are the problem and from the output below it was clear that the response strings were consuming (in my case) 90 odd percent of the memory that was currently in use by strings. but I didn't really have a good idea as to why they were not getting garbage collected.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">byid</span>  
 <span class="n">Set</span> <span class="n">of</span> <span class="mi">151666</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">226687040</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">1</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">42392032</span> <span class="mf">18.7</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">2</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">63588048</span> <span class="mf">28.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">3</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">84784064</span> <span class="mf">37.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">4</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">105980080</span> <span class="mf">46.8</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">5</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">127176096</span> <span class="mf">56.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">6</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">148372112</span> <span class="mf">65.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">7</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">169568128</span> <span class="mf">74.8</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">8</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">190764144</span> <span class="mf">84.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
    <span class="mi">9</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">211960160</span> <span class="mf">93.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...l</span><span class="s1">&#34;</span><span class="s1">: 2173762}}</span><span class="s1">&#39;</span>  
</code></pre></div><p>I then tried to find what was referencing the strings, perhaps we were holding an extra reference to the request object some where in ckan. Below is the shortest paths of references that heapy can find for the above strings</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="p">[</span><span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">shpaths</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="p">]</span><span class="p">)</span>  
 <span class="p">[</span> <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x4e56250</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x4e56e50</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x4e565f0</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x4ce2430</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x5433ab0</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">curframe</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">result</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
  <span class="mi">1</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">curframe_locals</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">result</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
  <span class="mi">2</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="n">im_self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">curframe</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">result</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
  <span class="mi">3</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="n">im_self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">curframe_locals</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">result</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x55288f0</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x4ce28d0</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x4ce21f0</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">,</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">routes</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_RequestConfig__shared_state</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">?</span><span class="err">?</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="n">x54339b0</span><span class="o">&gt;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">environ</span><span class="s1">&#39;</span><span class="p">]</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">pylons.controller</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_py_object</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">response</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">_body</span><span class="s1">&#39;</span><span class="p">]</span>  
</code></pre></div><p>So the <code>&quot;_RequestConfig__shared_state'].??[ &lt; weakref...x4e56250&gt;&quot;</code> in suggested that these objects should of been cleaned up once there was no longer a reference to them, a manual <code>gc.collect()</code> didn't seem to do anything and inspecting the <code>RequestConfig</code> <code>shared_state</code> showed it to be a <code>thread.local</code> object.</p>
<p>Using <code>.rp</code> shows a tree of references, so in this case, the str is contained in a dict of <code>pylons.controllers.util.Response</code> and that's contained in 3, dict of <code>pylons.util.PylonsContext</code> and so on and so forth</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="o">.</span><span class="o">.</span><span class="o">.</span>  
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rp</span>  
 <span class="n">Reference</span> <span class="n">Pattern</span> <span class="n">by</span> <span class="o">&lt;</span><span class="p">[</span><span class="nb">dict</span> <span class="n">of</span><span class="p">]</span> <span class="n">class</span><span class="o">&gt;</span><span class="o">.</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">_</span> <span class="o">-</span><span class="o">-</span><span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="nb">id</span> <span class="mh">0x7f21a9792010</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x7f21a9792010</span>  
  <span class="mi">1</span><span class="p">:</span> <span class="n">a</span>   <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span> <span class="mh">0x7f224a002550</span>  
  <span class="mi">2</span><span class="p">:</span> <span class="n">aa</span> <span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span> <span class="mh">0x7f224a002550</span>  
  <span class="mi">3</span><span class="p">:</span> <span class="n">a3</span>    <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PylonsContext</span><span class="p">:</span> <span class="mh">0x7f224a002790</span>  
  <span class="mi">4</span><span class="p">:</span> <span class="n">a4</span> <span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PylonsContext</span><span class="p">:</span> <span class="mh">0x7f224a002790</span>  
  <span class="mi">5</span><span class="p">:</span> <span class="n">a5</span>     <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">AttribSafeContextObj</span><span class="p">:</span> <span class="mh">0x7f224a002ad0</span>  
  <span class="mi">6</span><span class="p">:</span> <span class="n">a6</span> <span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">AttribSafeContextObj</span><span class="p">:</span> <span class="mh">0x7f224a002ad0</span>  
  <span class="mi">7</span><span class="p">:</span> <span class="n">a7</span>      <span class="p">[</span><span class="o">^</span> <span class="mi">3</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PylonsContext</span><span class="p">:</span> <span class="mh">0x7f224a002790</span>  
  <span class="mi">8</span><span class="p">:</span> <span class="n">a4b</span> <span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">ckan</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">ApiController</span><span class="p">:</span> <span class="mh">0x7f224a002c10</span>  
  <span class="mi">9</span><span class="p">:</span> <span class="n">a4ba</span>    <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">ckan</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">ApiController</span><span class="p">:</span> <span class="mh">0x7f224a002c10</span>  
 <span class="o">&lt;</span><span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_.more</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">more</span><span class="o">.</span><span class="o">&gt;</span>  
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rp</span><span class="o">.</span><span class="n">more</span>  
 <span class="mi">10</span><span class="p">:</span> <span class="n">a4baa</span> <span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span> <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span><span class="p">:</span> <span class="mh">0x7f222405ef30</span><span class="o">*</span><span class="mi">50</span>  
 <span class="mi">11</span><span class="p">:</span> <span class="n">a4bab</span>    <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="mi">1</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ckan</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">ApiController</span> <span class="o">.</span><span class="o">.</span><span class="o">.</span>  
</code></pre></div><p>At this point, I was moaning about my lack of progress with this problem on #ckan on freenode
So I wanted to see if what we have in memory is exactly the responses that we requested (or was it copying one request over and over? etc)
I ended up tweaking the script a bit and removing the total from the result dict returned by <code>datastore_search</code></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="kn">import</span> <span class="nn">json</span>  
 <span class="kn">import</span> <span class="nn">urllib</span>  
 <span class="kn">import</span> <span class="nn">urllib2</span>  
 <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  
 <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>  
   <span class="n">request_params</span> <span class="o">=</span> <span class="p">{</span>  
     <span class="sa"></span><span class="s1">&#39;</span><span class="s1">resource_id</span><span class="s1">&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">blah</span><span class="s1">&#39;</span><span class="p">,</span>  
     <span class="sa"></span><span class="s1">&#39;</span><span class="s1">offset</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  
     <span class="sa"></span><span class="s1">&#39;</span><span class="s1">limit</span><span class="s1">&#39;</span><span class="p">:</span> <span class="mi">100000</span> <span class="o">+</span> <span class="n">i</span>  
   <span class="p">}</span>  
   <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">http://localhost:5000/api/action/datastore_search</span><span class="s1">&#39;</span><span class="p">)</span>  
   <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request_params</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>  
   <span class="nb">str</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="p">)</span>  
   <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>  
   <span class="k">print</span> <span class="nb">str</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span><span class="p">]</span>  
   <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="p">)</span>  
   <span class="n">i</span> <span class="o">+</span><span class="o">=</span> <span class="mi">1</span> 
</code></pre></div><p>Not exactly the best code I've ever written, but it did mean that when we inspected using <code>.byid</code>, the output would look something like</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span>  
 <span class="n">Set</span> <span class="n">of</span> <span class="mi">137776</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">225205640</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21198840</span>  <span class="mf">9.4</span> <span class="mi">21198840</span>  <span class="mf">9.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100013}}</span><span class="s1">&#39;</span>  
    <span class="mi">1</span> <span class="mi">21198632</span>  <span class="mf">9.4</span> <span class="mi">42397472</span> <span class="mf">18.8</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100012}}</span><span class="s1">&#39;</span>  
    <span class="mi">2</span> <span class="mi">21198424</span>  <span class="mf">9.4</span> <span class="mi">63595896</span> <span class="mf">28.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100011}}</span><span class="s1">&#39;</span>  
    <span class="mi">3</span> <span class="mi">21198200</span>  <span class="mf">9.4</span> <span class="mi">84794096</span> <span class="mf">37.7</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100010}}</span><span class="s1">&#39;</span>  
    <span class="mi">4</span> <span class="mi">21197976</span>  <span class="mf">9.4</span> <span class="mi">105992072</span> <span class="mf">47.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100009}}</span><span class="s1">&#39;</span>  
    <span class="mi">5</span> <span class="mi">21197768</span>  <span class="mf">9.4</span> <span class="mi">127189840</span> <span class="mf">56.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100008}}</span><span class="s1">&#39;</span>  
    <span class="mi">6</span> <span class="mi">21197552</span>  <span class="mf">9.4</span> <span class="mi">148387392</span> <span class="mf">65.9</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100007}}</span><span class="s1">&#39;</span>  
    <span class="mi">7</span> <span class="mi">21197336</span>  <span class="mf">9.4</span> <span class="mi">169584728</span> <span class="mf">75.3</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100006}}</span><span class="s1">&#39;</span>  
    <span class="mi">8</span> <span class="mi">21197120</span>  <span class="mf">9.4</span> <span class="mi">190781848</span> <span class="mf">84.7</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100005}}</span><span class="s1">&#39;</span>  
    <span class="mi">9</span> <span class="mi">21196896</span>  <span class="mf">9.4</span> <span class="mi">211978744</span> <span class="mf">94.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100004}}</span><span class="s1">&#39;</span>  
 <span class="o">&lt;</span><span class="mi">137766</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_.more</span><span class="s1">&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.</span><span class="o">&gt;</span>  
</code></pre></div><p>This way, I could directly see which of the requests made are in memory, it was clear that we were dealing with the old requests being kept around in memory. I also took a look at the next couple of strings hanging around.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="o">.</span><span class="n">more</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
   <span class="mi">10</span>  <span class="mi">77528</span>  <span class="mf">0.0</span> <span class="mi">212056272</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">============...elease.</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="s1">&#39;</span>  
   <span class="mi">11</span>  <span class="mi">30712</span>  <span class="mf">0.0</span> <span class="mi">212086984</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Provide a re...n</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
   <span class="mi">12</span>  <span class="mi">22352</span>  <span class="mf">0.0</span> <span class="mi">212109336</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">(?&lt;=</span><span class="se">\\</span><span class="s1">()(</span><span class="se">\\</span><span class="s1">*...ng |zero</span><span class="se">\\</span><span class="s1">? )</span><span class="s1">&#39;</span>  
   <span class="mi">13</span>  <span class="mi">18016</span>  <span class="mf">0.0</span> <span class="mi">212127352</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Return a new....</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
   <span class="mi">14</span>  <span class="mi">13656</span>  <span class="mf">0.0</span> <span class="mi">212141008</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">.. dialect...stgreSQL.</span><span class="se">\n</span><span class="se">\n</span><span class="s1">&#39;</span>  
   <span class="mi">15</span>  <span class="mi">12480</span>  <span class="mf">0.0</span> <span class="mi">212153488</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">subprocess -...cess.Popen.</span><span class="se">\n</span><span class="s1">&#39;</span>  
   <span class="mi">16</span>  <span class="mi">12088</span>  <span class="mf">0.0</span> <span class="mi">212165576</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">Create a new...k</span><span class="s2">&#39;</span><span class="s2">``.</span><span class="se">\n</span><span class="se">\n</span><span class="s2">  </span><span class="s2">&#34;</span>  
   <span class="mi">17</span>  <span class="mi">11088</span>  <span class="mf">0.0</span> <span class="mi">212176664</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Create a SQL....</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
   <span class="mi">18</span>  <span class="mi">10904</span>  <span class="mf">0.0</span> <span class="mi">212187568</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Co....</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
   <span class="mi">19</span>  <span class="mi">10504</span>  <span class="mf">0.0</span> <span class="mi">212198072</span> <span class="mf">94.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Format...output.</span><span class="se">\n</span><span class="s1">  </span><span class="s1">&#39;</span>  
 <span class="o">&lt;</span><span class="mi">137756</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_.more</span><span class="s1">&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.</span><span class="o">&gt;</span>  
</code></pre></div><p>At this point, the first requests we made no longer appear in memory, the requests for 100000-100003 don't appear to be in memory.</p>
<p>So by doing some stepping through each request and stopping before the controller returned the response each time, we can see that it maintains a maximum of 10 response strings in memory and the older requests get shuffled off</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">c</span>  
 <span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">892</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">ckan</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">base</span><span class="p">]</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">action</span><span class="o">/</span><span class="n">datastore_search</span> <span class="n">render</span> <span class="n">time</span> <span class="mf">33.155</span> <span class="n">seconds</span>  
 <span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">joe</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">json_datastore</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ckan</span><span class="o">/</span><span class="n">ckan</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">api</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">82</span><span class="p">)</span><span class="fm">__call__</span><span class="p">(</span><span class="p">)</span>  
    <span class="mi">81</span>       <span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="p">)</span>  
 <span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">&gt;</span> <span class="mi">82</span>     <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">mem {0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">]</span><span class="p">)</span><span class="p">)</span>  
    <span class="mi">83</span>   
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span>  
 <span class="n">Set</span> <span class="n">of</span> <span class="mi">151739</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">226701936</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21199056</span>  <span class="mf">9.4</span> <span class="mi">21199056</span>  <span class="mf">9.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100014}}</span><span class="s1">&#39;</span>  
    <span class="mi">1</span> <span class="mi">21198840</span>  <span class="mf">9.4</span> <span class="mi">42397896</span> <span class="mf">18.7</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100013}}</span><span class="s1">&#39;</span>  
    <span class="mi">2</span> <span class="mi">21198632</span>  <span class="mf">9.4</span> <span class="mi">63596528</span> <span class="mf">28.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100012}}</span><span class="s1">&#39;</span>  
    <span class="mi">3</span> <span class="mi">21198424</span>  <span class="mf">9.4</span> <span class="mi">84794952</span> <span class="mf">37.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100011}}</span><span class="s1">&#39;</span>  
    <span class="mi">4</span> <span class="mi">21198200</span>  <span class="mf">9.4</span> <span class="mi">105993152</span> <span class="mf">46.8</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100010}}</span><span class="s1">&#39;</span>  
    <span class="mi">5</span> <span class="mi">21197976</span>  <span class="mf">9.4</span> <span class="mi">127191128</span> <span class="mf">56.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100009}}</span><span class="s1">&#39;</span>  
    <span class="mi">6</span> <span class="mi">21197768</span>  <span class="mf">9.4</span> <span class="mi">148388896</span> <span class="mf">65.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100008}}</span><span class="s1">&#39;</span>  
    <span class="mi">7</span> <span class="mi">21197552</span>  <span class="mf">9.4</span> <span class="mi">169586448</span> <span class="mf">74.8</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100007}}</span><span class="s1">&#39;</span>  
    <span class="mi">8</span> <span class="mi">21197336</span>  <span class="mf">9.4</span> <span class="mi">190783784</span> <span class="mf">84.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100006}}</span><span class="s1">&#39;</span>  
    <span class="mi">9</span> <span class="mi">21197120</span>  <span class="mf">9.4</span> <span class="mi">211980904</span> <span class="mf">93.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100005}}</span><span class="s1">&#39;</span>  
 <span class="o">&lt;</span><span class="mi">151729</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_.more</span><span class="s1">&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.</span><span class="o">&gt;</span>  
</code></pre></div><p>100004 has been wiped off. At this point after some discussion on irc, we thought it might be the fact that we're in debug mode, and it's just retaining the last 10 responses and their debugging information. but the problem remained when I set &ldquo;debug = false&rdquo; in my ckan development.ini</p>
<p>The thing is ten is far too perfect a number, we humans deal with numbers in batches of ten, if this was a random occurence, it was unlikely that there would just happen to be ten requests hanging around. It was more likely that the ten requests hanging around were the result of some config setting somewhere, where the default was ten.</p>
<p>I pieced together the weakref, thread.local stuff with <a href="http://pythonpaste.org/paste-httpserver-threadpool.html">http://pythonpaste.org/paste-httpserver-threadpool.html</a> and noticed that the <em>default number of threads for the paste http server is 10</em>. I then tested by changing the <code>threadpool_workers=n</code> in my ckan development.ini, and each time it matched the number of strings that showed up in <code>heap[0].byid</code>.</p>
<p>The other thing to notice is that if I made 10 new requests to api endpoints that return a much smaller response</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">Set</span> <span class="n">of</span> <span class="mi">151950</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">78397616</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21199280</span> <span class="mf">27.0</span> <span class="mi">21199280</span> <span class="mf">27.0</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100015}}</span><span class="s1">&#39;</span>  
    <span class="mi">1</span> <span class="mi">21199056</span> <span class="mf">27.0</span> <span class="mi">42398336</span> <span class="mf">54.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100014}}</span><span class="s1">&#39;</span>  
    <span class="mi">2</span> <span class="mi">21198840</span> <span class="mf">27.0</span> <span class="mi">63597176</span> <span class="mf">81.1</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...it</span><span class="s1">&#34;</span><span class="s1">: 100013}}</span><span class="s1">&#39;</span>  
    <span class="mi">3</span>  <span class="mi">77528</span>  <span class="mf">0.1</span> <span class="mi">63674704</span> <span class="mf">81.2</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">============...elease.</span><span class="se">\n</span><span class="se">\n</span><span class="se">\n</span><span class="s1">&#39;</span>  
    <span class="mi">4</span>  <span class="mi">30712</span>  <span class="mf">0.0</span> <span class="mi">63705416</span> <span class="mf">81.3</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Provide a re...n</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
    <span class="mi">5</span>  <span class="mi">22352</span>  <span class="mf">0.0</span> <span class="mi">63727768</span> <span class="mf">81.3</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">(?&lt;=</span><span class="se">\\</span><span class="s1">()(</span><span class="se">\\</span><span class="s1">*...ng |zero</span><span class="se">\\</span><span class="s1">? )</span><span class="s1">&#39;</span>  
    <span class="mi">6</span>  <span class="mi">18016</span>  <span class="mf">0.0</span> <span class="mi">63745784</span> <span class="mf">81.3</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Return a new....</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
    <span class="mi">7</span>  <span class="mi">13656</span>  <span class="mf">0.0</span> <span class="mi">63759440</span> <span class="mf">81.3</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">.. dialect...stgreSQL.</span><span class="se">\n</span><span class="se">\n</span><span class="s1">&#39;</span>  
    <span class="mi">8</span>  <span class="mi">12480</span>  <span class="mf">0.0</span> <span class="mi">63771920</span> <span class="mf">81.3</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">subprocess -...cess.Popen.</span><span class="se">\n</span><span class="s1">&#39;</span>  
    <span class="mi">9</span>  <span class="mi">12088</span>  <span class="mf">0.0</span> <span class="mi">63784008</span> <span class="mf">81.4</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">Create a new...k</span><span class="s2">&#39;</span><span class="s2">``.</span><span class="se">\n</span><span class="se">\n</span><span class="s2">  </span><span class="s2">&#34;</span>  
 <span class="o">&lt;</span><span class="mi">151940</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_.more</span><span class="s1">&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.</span><span class="o">&gt;</span>  
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="o">.</span><span class="n">more</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
   <span class="mi">10</span>  <span class="mi">11088</span>  <span class="mf">0.0</span> <span class="mi">63795096</span> <span class="mf">81.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Create a SQL....</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
   <span class="mi">11</span>  <span class="mi">10904</span>  <span class="mf">0.0</span> <span class="mi">63806000</span> <span class="mf">81.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Co....</span><span class="se">\n</span><span class="se">\n</span><span class="s1">    </span><span class="s1">&#39;</span>  
   <span class="mi">12</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63816584</span> <span class="mf">81.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...facets</span><span class="s1">&#34;</span><span class="s1">: {}}}</span><span class="s1">&#39;</span>  <span class="p">(</span><span class="n">the</span> <span class="n">smaller</span> <span class="n">api</span> <span class="n">responses</span><span class="p">)</span>  
   <span class="mi">13</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63827168</span> <span class="mf">81.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...facets</span><span class="s1">&#34;</span><span class="s1">: {}}}</span><span class="s1">&#39;</span>  
   <span class="mi">14</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63837752</span> <span class="mf">81.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...facets</span><span class="s1">&#34;</span><span class="s1">: {}}}</span><span class="s1">&#39;</span>  
   <span class="mi">15</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63848336</span> <span class="mf">81.4</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...facets</span><span class="s1">&#34;</span><span class="s1">: {}}}</span><span class="s1">&#39;</span>  
   <span class="mi">16</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63858920</span> <span class="mf">81.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...facets</span><span class="s1">&#34;</span><span class="s1">: {}}}</span><span class="s1">&#39;</span>  
   <span class="mi">17</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63869504</span> <span class="mf">81.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">{</span><span class="s1">&#34;</span><span class="s1">help</span><span class="s1">&#34;</span><span class="s1">: </span><span class="s1">&#34;</span><span class="s1">ht...facets</span><span class="s1">&#34;</span><span class="s1">: {}}}</span><span class="s1">&#39;</span>  
   <span class="mi">18</span>  <span class="mi">10504</span>  <span class="mf">0.0</span> <span class="mi">63880008</span> <span class="mf">81.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Format...output.</span><span class="se">\n</span><span class="s1">  </span><span class="s1">&#39;</span>  
   <span class="mi">19</span>   <span class="mi">9168</span>  <span class="mf">0.0</span> <span class="mi">63889176</span> <span class="mf">81.5</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">Represent a ...ents.</span><span class="se">\n</span><span class="se">\n</span><span class="s1">  </span><span class="s1">&#39;</span>  
 <span class="o">&lt;</span><span class="mi">151930</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">_.more</span><span class="s1">&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.</span><span class="o">&gt;</span>  
</code></pre></div><p>you'll see the total size has dropped from 226701936 bytes to 78397616 bytes. But the entire time that I had been debugging, I had also been running</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"> $ watch <span class="s2">&#34;cat /proc/`pgrep paster`/status&#34;</span>  
 ...  
 VmPeak: <span class="m">3497708</span> kB  
 VmSize: <span class="m">3497708</span> kB  
 ...  
</code></pre></div><p>Which still reports the memory usage the same as when the larger requests were still in memory. This is apparently just the way python works (see <a href="https://groups.google.com/forum/#!topic/celery-users/jVc3I3kPtlw)">https://groups.google.com/forum/#!topic/celery-users/jVc3I3kPtlw)</a>. If you've just made a response that took up 500mb of memory, it stands to reason that you might have to do the same again quite soon, so python will hang onto the (virtual) memory. But it's not &lsquo;leaked&rsquo;</p>
<p><a href="http://pylons-webframework.readthedocs.org/en/latest/controllers.html#special-methods,">http://pylons-webframework.readthedocs.org/en/latest/controllers.html#special-methods,</a> The next step was to investigate whether it's ok to clear out the string in something like the <strong>after</strong>() method of the controller. I ended up creating some pylons specific cleanup middleware (see <a href="https://github.com/ckan/ckan/pull/2262">https://github.com/ckan/ckan/pull/2262</a>)</p>
<p>Once the response string has been served, this middleware replaces the response string with a dummy one, so the original response can be garbage collected. This was lifted from <a href="https://code.google.com/p/modwsgi/wiki/RegisteringCleanupCode">https://code.google.com/p/modwsgi/wiki/RegisteringCleanupCode</a> This middleware is can be switched on by setting &lsquo;ckan.use_pylons_response_cleanup_middleware = true&rsquo; in your development.ini</p>
<p>So I did a comparison of with and without this enabled. Everyone likes graphs right?</p>
<p><img src="/ckan_memory_usage.png" alt="memory usage"></p>
<p>Notably, the memory usage still grows with this enabled, but is a bit more stable. I also did some examining of the memory and this memory has been returned to python's free lists but has not been released by the python process. see (<a href="http://effbot.org/pyfaq/why-doesnt-python-release-the-memory-when-i-delete-a-large-object.htm)">http://effbot.org/pyfaq/why-doesnt-python-release-the-memory-when-i-delete-a-large-object.htm)</a>. So we'll still use up as much memory as there are threads</p>
<p>So the other way around it is to do something like use gunicorn + gevent, although this isn't a fair direct comparison as this is only using one worker process, but I mainly suggest this as you can set worker processes to restart after serving a maximum number of requests (see <a href="http://docs.gunicorn.org/en/develop/configure.html#max-requests),">http://docs.gunicorn.org/en/develop/configure.html#max-requests),</a> which would release any memory that the process has been allocated but is not using.</p>
<p>Finally it was noted that we probably shouldn't be building up the entire response in memory before returning it this is because we're using json.dumps for the response string. It would be better if we had an iterator of some form to stream the response back.</p>
<p>If you want to help fix it, take a look at  <a href="https://github.com/ckan/ideas-and-roadmap/issues/128">https://github.com/ckan/ideas-and-roadmap/issues/128</a></p>
<p>Next time I look into a python memory issue, I'd like to use meliae (<a href="https://pypi.python.org/pypi/meliae">https://pypi.python.org/pypi/meliae</a>) or some other interesting tools. Anyway that was some fun sleuthing.</p>
<h4 id="heapy-docs">heapy docs<a href="#heapy-docs" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<ul>
<li><a href="http://guppy-pe.sourceforge.net/heapy-thesis.pdf">http://guppy-pe.sourceforge.net/heapy-thesis.pdf</a></li>
<li><a href="http://smira.ru/wp-content/uploads/2011/08/heapy.html">http://smira.ru/wp-content/uploads/2011/08/heapy.html</a></li>
<li><a href="http://haypo-notes.readthedocs.org/en/latest/heap_fragmentation.html">http://haypo-notes.readthedocs.org/en/latest/heap_fragmentation.html</a></li>
<li><a href="https://chase-seibert.github.io/blog/2013/08/03/diagnosing-memory-leaks-python.html">https://chase-seibert.github.io/blog/2013/08/03/diagnosing-memory-leaks-python.html</a></li>
<li><a href="http://forthescience.org/blog/2014/08/16/python-and-memory-fragmentation/">http://forthescience.org/blog/2014/08/16/python-and-memory-fragmentation/</a></li>
</ul>
<h4 id="weak-references">weak references<a href="#weak-references" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<ul>
<li><a href="https://docs.python.org/2/library/weakref.html">https://docs.python.org/2/library/weakref.html</a></li>
<li><a href="http://pymotw.com/2/weakref/">http://pymotw.com/2/weakref/</a></li>
</ul>
<h4 id="pylons-docs">pylons docs<a href="#pylons-docs" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<ul>
<li><a href="http://pylons-webframework.readthedocs.org/en/latest/execution.html">http://pylons-webframework.readthedocs.org/en/latest/execution.html</a></li>
<li><a href="http://pythonpaste.org/paste-httpserver-threadpool.html">http://pythonpaste.org/paste-httpserver-threadpool.html</a></li>
</ul>
<p>(This post was constructed from <a href="https://github.com/ckan/ckan/issues/1847,">https://github.com/ckan/ckan/issues/1847,</a> <a href="https://github.com/ckan/ckan/pull/2262">https://github.com/ckan/ckan/pull/2262</a>)</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://the.chuntering.dev/tags/ckan">ckan</a></span><span class="tag"><a href="https://the.chuntering.dev/tags/debugging">debugging</a></span><span class="tag"><a href="https://the.chuntering.dev/tags/python">python</a></span><span class="tag"><a href="https://the.chuntering.dev/tags/heapy">heapy</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>2255 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2015-06-01 01:00 &#43;0100</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://the.chuntering.dev/posts/random-traitor-numbers-in-trouble-in-terrorist-town/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>Randomising Traitor Numbers in Trouble in Terrorist Town</span>
			</a>
			<a class="prev-post" href="https://the.chuntering.dev/posts/wtf-is-this-context-thing-in-ckan/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>WTF is this context thing in CKAN?</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://the.chuntering.dev">Joe</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://the.chuntering.dev/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://the.chuntering.dev/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	<script>
	(function() {
		var script = document.createElement('script');
		window.counter = 'https://chunteringdev.goatcounter.com/count'
		script.async = 1;
		script.src = '//gc.zgo.at/count.js';

		var ins = document.getElementsByTagName('script')[0];
		ins.parentNode.insertBefore(script, ins)
	})();
</script>

</body>

</html>
