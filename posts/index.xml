<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on Joe T</title>
		<link>https://the.chuntering.dev/posts/</link>
		<description>Recent content in Posts on Joe T</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>en-gb</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Thu, 01 Aug 2019 00:00:00 +0000</lastBuildDate>
		<atom:link href="https://the.chuntering.dev/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>Django Admin Single Line Unlimited Input For Postgres</title>
			<link>https://the.chuntering.dev/posts/django-admin-single-line-unlimited-input/</link>
			<pubDate>Thu, 01 Aug 2019 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/django-admin-single-line-unlimited-input/</guid>
			<description>If you need a single line input for a CharField in django admin but want unlimited length input? Are you using postgres? Then you can use this snippet.
 varchar(n) is Bad See https://wiki.postgresql.org/wiki/Don%27t_Do_This#Don.27t_use_varchar.28n.29_by_default
Why not TextArea? Why not use TextArea? This defaults to a multiline input, and you&amp;rsquo;d need to override it for every single CharField you use.
https://stackoverflow.com/questions/3469979/django-admin-overriding-the-widget-of-a-custom-form-field/4466958#4466958
How does it work? We override the database used in the CharField and just use varchar, This is the same perfomance wise as varchar(n) and text.</description>
			<content type="html"><![CDATA[

<p>If you need a single line input for a <code>CharField</code> in django admin but want
unlimited length input? Are you using postgres? Then you can use this snippet.</p>

<script type="application/javascript" src="//gist.github.com/joetsoi/8158748202e5174dbf72c8daa8e71dcb.js"></script>

<h1 id="varchar-n-is-bad"><code>varchar(n)</code> is Bad</h1>

<p>See <a href="https://wiki.postgresql.org/wiki/Don%27t_Do_This#Don.27t_use_varchar.28n.29_by_default" target="_blank">https://wiki.postgresql.org/wiki/Don%27t_Do_This#Don.27t_use_varchar.28n.29_by_default</a></p>

<h1 id="why-not-textarea">Why not <code>TextArea</code>?</h1>

<p>Why not use <code>TextArea</code>? This defaults to a multiline input, and you&rsquo;d need
to override it for every single <code>CharField</code> you use.</p>

<p><a href="https://stackoverflow.com/questions/3469979/django-admin-overriding-the-widget-of-a-custom-form-field/4466958#4466958" target="_blank">https://stackoverflow.com/questions/3469979/django-admin-overriding-the-widget-of-a-custom-form-field/4466958#4466958</a></p>

<h1 id="how-does-it-work">How does it work?</h1>

<p>We override the database used in the <code>CharField</code> and just use <code>varchar</code>,
This is the same perfomance wise as <code>varchar(n)</code> and <code>text</code>.</p>

<p>There&rsquo;s also the django based python check and where we pass in <code>sys.maxsize</code> so we
cover most possible sizes.</p>

<p><a href="https://docs.djangoproject.com/en/2.2/ref/models/fields/#django.db.models.CharField.max_length" target="_blank">https://docs.djangoproject.com/en/2.2/ref/models/fields/#django.db.models.CharField.max_length</a></p>

<h2 id="other-people-who-have-also-done-this">Other people who have also done this.</h2>

<p>Jacob Kaplan-Moss also go annoyed enough to to this as well.
<a href="https://github.com/jacobian/django-postgres-unlimited-varchar" target="_blank">https://github.com/jacobian/django-postgres-unlimited-varchar</a></p>

<p>Looks like he skips the size check entirely. Not knowing the internals of django
admin as well as he does, I opted for letting the code run without messing
with it too much.</p>

<p>Glad I&rsquo;m not the only one who was bugged by this.</p>
]]></content>
		</item>
		
		<item>
			<title>OpenMoonstone V0.2 Released</title>
			<link>https://the.chuntering.dev/posts/openmoonstone-v0-2-released/</link>
			<pubDate>Wed, 16 Jan 2019 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/openmoonstone-v0-2-released/</guid>
			<description># OpenMoonstone v0.2 released OpenMoonstone is a open source reimplementation of Moonstone: A Hard Day&amp;rsquo;s Knight following along the lines of projects like OpenTTD and OpenXcom. You can try it out https://github.com/joetsoi/OpenMoonstone
This release is a milestone as it contains the same number of features as the original demo that came out on the Amiga.
Why reimplement an old game? Fixing bugs   Original     OpenMoonstone v0.</description>
			<content type="html"><![CDATA[

<p># OpenMoonstone v0.2 released
OpenMoonstone is a open source reimplementation of Moonstone: A Hard Day&rsquo;s Knight following along the lines of projects like OpenTTD and OpenXcom. You can try it out <a href="https://github.com/joetsoi/OpenMoonstone" target="_blank">https://github.com/joetsoi/OpenMoonstone</a></p>

<p>This release is a milestone as it contains the same number of features as the original demo that came out on the Amiga.</p>

<h2 id="why-reimplement-an-old-game">Why reimplement an old game?</h2>

<h3 id="fixing-bugs">Fixing bugs</h3>

<p><figure>
    <img src="/oldbk-opt.gif"/> <figcaption>
            <h4>Original</h4>
        </figcaption>
</figure>

<figure>
    <img src="/newbk-opt.gif"/> <figcaption>
            <h4>OpenMoonstone v0.2</h4>
        </figcaption>
</figure>
</p>

<p>Enemies always face the player in Moonstone, in the original this meant that for the AI controlled knights, the distance the knight would move was out of sync with the animation causing a &ldquo;jumpy&rdquo; animation.</p>

<h3 id="adding-new-features">Adding New Features</h3>

<p>I&rsquo;ve added the ability for four players to fight at once. The amiga only had two controller ports so was restricted to two players, as a child I always wanted a three way battle with my brothers and adding additional entities in an ECS is easy once it&rsquo;s all set up.
<figure>
    <img src="/4players.png"/> <figcaption>
            <h4>four players at once</h4>
        </figcaption>
</figure>
</p>

<h3 id="as-a-side-project">As a side project</h3>

<p>It&rsquo;s hard to stay motivated when working on a side project, but this has a few advantages</p>

<ul>
<li>Predefined scope (it&rsquo;s done when it matches original).</li>
<li>No need to create any art assets</li>
<li>Fueled by nostalgia.</li>
<li>A good way to try out a new programming language (Rust in this case).</li>
</ul>

<p>But it has some distinct disadvantages</p>

<ul>
<li>Reverse engineering 16bit x86 is time consuming. (Avoid doing this if you can)</li>
</ul>

<p>This is the probably the furthest I&rsquo;ve ever got with a side project, in the future it would be nice to add modding or other features, but that&rsquo;s for another day.</p>
]]></content>
		</item>
		
		<item>
			<title>Horrible Things I Regret Doing With Python</title>
			<link>https://the.chuntering.dev/posts/horrible-things-i-regret-doing-with-python/</link>
			<pubDate>Tue, 07 Mar 2017 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/horrible-things-i-regret-doing-with-python/</guid>
			<description>Runtime Copy Paste With Global Variable Replacement. &amp;ldquo;Could you make InlineAdmin in Django paginatable Joe?&amp;rdquo; Guido asked. I googled a while before regurgitating a Stackoverflow answer into Guido&amp;rsquo;s lap. &amp;ldquo;Oh cool, but we have multiple InlineAdmins, can you make it paginate for all of them?&amp;rdquo; &amp;ldquo;Sure&amp;rdquo; I replied, &amp;ldquo;That&amp;rsquo;ll just be a change to the admin class and some templates&amp;rdquo;
&amp;hellip; Time passes
I had quickly changed the p variable so it was dynamically determined by the model name assigned to the InlineAdmin class by adding a page_param property.</description>
			<content type="html"><![CDATA[

<h2 id="runtime-copy-paste-with-global-variable-replacement">Runtime Copy Paste With Global Variable Replacement.</h2>

<p>&ldquo;Could you make <code>InlineAdmin</code> in Django paginatable Joe?&rdquo; Guido asked.
 I googled a while before regurgitating a Stackoverflow answer into Guido&rsquo;s lap.
&ldquo;Oh cool, but we have multiple <code>InlineAdmins</code>, can you make it paginate for all of them?&rdquo;
&ldquo;Sure&rdquo; I replied, &ldquo;That&rsquo;ll just be a change to the admin class and some templates&rdquo;</p>

<p>&hellip; Time passes</p>

<p>I had quickly changed the <code>p</code> variable so it was dynamically determined by the model name assigned to the <code>InlineAdmin</code> class by adding a <code>page_param</code> property. The only problem was I that needed django&rsquo;s <code>paginator_number</code> template tag to take into account these new page variables as well.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.contrib.admin.views.main</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ALL_VAR</span><span class="p">,</span> <span class="n">ORDER_VAR</span><span class="p">,</span> <span class="n">PAGE_VAR</span><span class="p">,</span> <span class="n">SEARCH_VAR</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">...</span>

<span class="nd">@register.simple_tag</span>
<span class="k">def</span> <span class="nf">paginator_number</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;
</span><span class="s2">    Generates an individual page index link in a paginated list.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">DOT</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;... &#39;</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cl</span><span class="o">.</span><span class="n">page_num</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s1">&#39;&lt;span class=&#34;this-page&#34;&gt;{}&lt;/span&gt; &#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&#34;{}&#34;{}&gt;{}&lt;/a&gt; &#39;</span><span class="p">,</span>
                           <span class="n">cl</span><span class="o">.</span><span class="n">get_query_string</span><span class="p">({</span><span class="n">PAGE_VAR</span><span class="p">:</span> <span class="n">i</span><span class="p">}),</span>
                           <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39; class=&#34;end&#34;&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cl</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">num_pages</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
<span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></code></pre></div>
<p>The main problem being that <code>PAGE_VAR</code> is a global variable in <code>paginator_number</code> and I was trying as hard as possible to avoid copy pasting. I pondered for a while before writing out the code vomit in the next sample.</p>

<p>&ldquo;Can you see what he&rsquo;s doing?&rdquo; Tom called out, slightly exasperated as he looked at the hideous code I  had concocted. I cackled slightly as the other devs gathered around my desk, the faint glow of monitor lighting their faces.</p>

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ln"> 1</span><span class="kn">import</span> <span class="nn">copy</span>
<span class="ln"> 2</span><span class="kn">import</span> <span class="nn">types</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Library</span>
<span class="ln"> 5</span><span class="kn">from</span> <span class="nn">django.contrib.admin.templatetags.admin_list</span> <span class="kn">import</span> <span class="p">(</span>
<span class="ln"> 6</span>    <span class="n">paginator_number</span><span class="p">,</span>
<span class="ln"> 7</span>    <span class="n">pagination</span>
<span class="ln"> 8</span><span class="p">)</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="n">register</span> <span class="o">=</span> <span class="n">Library</span><span class="p">()</span>
<span class="ln">11</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="nd">@register.simple_tag</span>
<span class="ln">14</span><span class="k">def</span> <span class="nf">parameterized_paginator_number</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="ln">15</span>    <span class="s1">&#39;&#39;&#39;This ridiculous code makes a copy of paginator_number function
</span><span class="ln">16</span><span class="s1">    The PAGE_VAR variable is global in paginator number, this
</span><span class="ln">17</span><span class="s1">    function copies paginator_number and replaces the global PAGE_VAR
</span><span class="ln">18</span><span class="s1">    with a page_param that we can set.
</span><span class="ln">19</span><span class="s1">    &#39;&#39;&#39;</span>
<span class="ln">20</span>    <span class="c1"># copy the globals of paginator_number</span>
<span class="ln">21</span>    <span class="n">func_globals_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">paginator_number</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">)</span>
<span class="ln">22</span>    <span class="n">func_globals_copy</span><span class="p">[</span><span class="s1">&#39;PAGE_VAR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">page_param</span>
<span class="ln">23</span>
<span class="ln">24</span>    <span class="n">paginator_number_func_copy</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span>
<span class="ln">25</span>        <span class="n">code</span><span class="o">=</span><span class="n">paginator_number</span><span class="o">.</span><span class="vm">__code__</span><span class="p">,</span>
<span class="ln">26</span>        <span class="c1"># pass our updated globals</span>
<span class="ln">27</span>        <span class="nb">globals</span><span class="o">=</span><span class="n">func_globals_copy</span><span class="p">,</span>
<span class="ln">28</span>        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;parameterized_paginator_number&#39;</span><span class="p">,</span>
<span class="ln">29</span>        <span class="n">argdefs</span><span class="o">=</span><span class="n">paginator_number</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">,</span>
<span class="ln">30</span>        <span class="n">closure</span><span class="o">=</span><span class="n">paginator_number</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">,</span>
<span class="ln">31</span>    <span class="p">)</span>
<span class="ln">32</span>    <span class="k">return</span> <span class="n">paginator_number_func_copy</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span></code></pre></div>

<p>&ldquo;It&rsquo;s runtime copy pasting, what the hell is wrong with you?&rdquo;</p>

<p>Here we use copy to make a copy of django&rsquo;s <code>paginator_number</code>&rsquo;s global (line 21). Then, in a horrible twist, we replace the <code>PAGE_VAR</code> in our new dict (line 22).</p>

<p>In line 24-31, we use the types library to create a new function. With exactly the same code as <code>paginator_number</code>, but crucially in line 27, we pass in our <code>func_globals_copy</code>, which contains the replaced <code>PAGE_VAR</code> global. Then we invoke our new <code>paginator_number</code> function copy and all is well.</p>

<p>Under the hood, each python function has a reference to a dict containing all the globals that the function uses, all we are doing is badly abusing this. #sorrynotsorry as they say.</p>

<p>&ldquo;This is your fault django, you made me do this&rdquo;, I blurted out in some feeble attempt at an excuse following up with &ldquo;I think it&rsquo;s less brittle than plain copy-pasting though&rdquo;.</p>

<p>&ldquo;I actually agree.&rdquo; Tom said doing his best Patrick Stewart facepalm.</p>
]]></content>
		</item>
		
		<item>
			<title>A Hard Days Knight</title>
			<link>https://the.chuntering.dev/posts/a-hard-days-knight/</link>
			<pubDate>Wed, 16 Mar 2016 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/a-hard-days-knight/</guid>
			<description>After many hours I&amp;rsquo;ve succeeded in reverse engineering a small part of the old DOS game Moonstone!I plan on posting all the gory details, but it&amp;rsquo;s a bit late at the moment but just running the image viewer script I hacked together and seeing the working result is so pleasing.</description>
			<content type="html"><![CDATA[<p><img src="/mindscap.png" alt="mindscape" />
After many hours I&rsquo;ve succeeded in reverse engineering a small part of the old DOS game Moonstone!I plan on posting all the gory details, but it&rsquo;s a bit late at the moment but just running the image viewer script I hacked together and seeing the working result is so pleasing.</p>
]]></content>
		</item>
		
		<item>
			<title>SQLTap and CKAN</title>
			<link>https://the.chuntering.dev/posts/sqltap-and-ckan/</link>
			<pubDate>Fri, 18 Sep 2015 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/sqltap-and-ckan/</guid>
			<description>Are you a CKAN developer? Have you had a trip or fall at work involving a slow running sql query that wasn&amp;rsquo;t your fault? Do you terribly miss the django debug toolbar, pyramid debugtoolbar, flask debugtoolbar or similar? Well you&amp;rsquo;re basically screwed, but to help alleviate the pain I made a tiny ckan extension that integrates the SQLTap middleware with ckan, once you&amp;rsquo;ve added &amp;lsquo;sqltap&amp;rsquo; to your list of plugins in your development init you&amp;rsquo;ll find the sqltap interface at</description>
			<content type="html"><![CDATA[<p>Are you a CKAN developer? Have you had a trip or fall at work involving a slow running sql query that wasn&rsquo;t your fault? Do you terribly miss the <a href="https://github.com/django-debug-toolbar/django-debug-toolbar" target="_blank">django debug toolbar</a>, <a href="https://github.com/Pylons/pyramid_debugtoolbar" target="_blank">pyramid debugtoolbar</a>, <a href="https://pypi.python.org/pypi/Flask-DebugToolbar" target="_blank">flask debugtoolbar</a> or similar? Well you&rsquo;re basically screwed, but to help alleviate the pain I made a <a href="https://github.com/joetsoi/ckanext-sqltap" target="_blank">tiny ckan extension</a> that integrates the <a href="http://sqltap.inconshreveable.com/" target="_blank">SQLTap middleware</a> with ckan, once you&rsquo;ve added &lsquo;sqltap&rsquo; to your list of plugins in your development init you&rsquo;ll find the sqltap interface at</p>

<p><a href="http://localhost:5000/__sqltap__" target="_blank">http://localhost:5000/__sqltap__</a></p>

<p>When you run the paster development server. Please don&rsquo;t cry when you see the results there, we&rsquo;ll get round to implementing <a href="https://github.com/ckan/ckan/issues/2353" target="_blank">dogpile caching</a> eventually</p>
]]></content>
		</item>
		
		<item>
			<title>Translating Ckan Extensions Using The ITranslations Interface</title>
			<link>https://the.chuntering.dev/posts/translating-ckan-extensions-using-itranslations-interface/</link>
			<pubDate>Wed, 09 Sep 2015 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/translating-ckan-extensions-using-itranslations-interface/</guid>
			<description>From ckan 2.5 onwards you will be able to translate the strings in ckan extensions in a much more friendly and easy way. Unless there are any major issues in the code review, this pull request should make your life easier.
Previously, there were a few, not ideal solutions (see ckan#959) which involved having a paster command or script that would munge all the po/mo files together using gettext&amp;rsquo;s msgcat command.</description>
			<content type="html"><![CDATA[<p>From ckan 2.5 onwards you will be able to translate the strings in ckan extensions in a much more friendly and easy way. Unless there are any major issues in the code review, <a href="https://github.com/ckan/ckan/pull/2461" target="_blank">this pull request</a> should make your life easier.</p>

<p>Previously, there were a few, not ideal solutions (see <a href="https://github.com/ckan/ckan/issues/959" target="_blank">ckan#959</a>) which involved having a paster command or script that would munge all the po/mo files together using gettext&rsquo;s msgcat command.</p>

<p>This has the downside that the sysadmin of any ckan instance would have to run this script and whatever other series of texts whenever they had a new ckan extension that they wanted to add.</p>

<p>The new pull request allows extension writers to provide a translations that will automatically be included without any additional steps other than the standard step specifying the plugin in the ckan.plugins in the configuration file.</p>

<p>To do this you&rsquo;ll need to copy the example plugin and edit your plugin so it looks a bit like</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">...</span>
<span class="kn">from</span> <span class="nn">ckan.lib.plugins</span> <span class="kn">import</span> <span class="n">DefaultTranslation</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">MyPlugin</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">SingletonPlugin</span><span class="p">,</span> <span class="n">DefaultTranslation</span><span class="p">):</span>
    <span class="n">plugins</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">plugins</span><span class="o">.</span><span class="n">ITranslation</span><span class="p">)</span>
<span class="o">...</span></code></pre></div>
<p>The <code>ITranslation</code> interface and <code>DefaultTranslation</code> will mean that ckan will look for a directory in your extension <code>ckanext/&lt;your extension&gt;/i18n</code> for possible translations, your translation file for each locale should be <code>ckanext-&lt;your extension&gt;</code>. This is actually a gettext domain, in the future we might be able to add some more flexibility it so that only strings in an extension get overwritten even if they are the same as a ckan core string.</p>

<p>If you need help on gettext and how it works for ckan you should check out <a href="http://docs.ckan.org/en/latest/contributing/i18n.html" target="_blank">the ckan translation docs</a>. Or take a look at the <code>example_itranslation_plugin</code> in the pull request</p>

<p>Given the previous attempts to fix this, I was pleasantly surprised with how much fun I had writing this.</p>

<p>Babel has support for an <a href="http://babel.pocoo.org/docs/support/#extended-translations-class" target="_blank">extended translation class</a> that allows you to merge translations with an existing one. The problem was getting ckan to use it, I was expecting some awful hacks or messy code.</p>

<p>After poking around the source code to babel and pylons, it turns out that pylons eventually passes kwargs from <code>set_lang</code> to <code>_get_translator</code> which passes its keyword arguments to gettext , which is not mentioned in the pylons <a href="https://pylons-webframework.readthedocs.org/en/latest/modules/i18n_translation.html#pylons.i18n.translation.set_lang" target="_blank">documentation</a>. But that is the price you pay for being stuck on an older framework</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">pylons</span><span class="o">/</span><span class="mi">18</span><span class="n">n</span><span class="o">/</span><span class="n">translation</span><span class="o">.</span><span class="n">py</span>

<span class="n">gettext</span> <span class="kn">import</span> <span class="nn">NullTranslations</span><span class="o">,</span> <span class="nn">translation</span>
<span class="o">...</span>
<span class="k">def</span> <span class="nf">_get_translator</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="o">....</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="n">translation</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;pylons.package&#39;</span><span class="p">],</span> <span class="n">localedir</span><span class="p">,</span>
                                 <span class="n">languages</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">ioe</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LanguageError</span><span class="p">(</span><span class="s1">&#39;IOError: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ioe</span><span class="p">)</span>
    <span class="n">translator</span><span class="o">.</span><span class="n">pylons_lang</span> <span class="o">=</span> <span class="n">lang</span>
    <span class="k">return</span> <span class="n">translator</span>

<span class="k">def</span> <span class="nf">set_lang</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">translator</span> <span class="o">=</span> <span class="n">_get_translator</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="o">...</span></code></pre></div>
<p>In gettext <a href="https://docs.python.org/2/library/gettext.html#gettext.translation" target="_blank">translation</a>, you can pass a Translation class in as the class parameter, so all it really involves is getting ckan to tell pylons to use the babel Translation class instead.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">babel.support</span> <span class="kn">import</span> <span class="n">Translations</span>
<span class="o">...</span>
<span class="k">def</span> <span class="nf">_set_lang</span><span class="p">(</span><span class="n">lang</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ckan.i18n_directory&#39;</span><span class="p">):</span>
        <span class="n">fake_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pylons.paths&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ckan.i18n_directory&#39;</span><span class="p">]},</span>
                       <span class="s1">&#39;pylons.package&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pylons.package&#39;</span><span class="p">]}</span>
        <span class="n">i18n</span><span class="o">.</span><span class="n">set_lang</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">pylons_config</span><span class="o">=</span><span class="n">fake_config</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">Translations</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i18n</span><span class="o">.</span><span class="n">set_lang</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">Translations</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tmpl_context</span><span class="p">):</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CKAN_LANG&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ckan.locale_default&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;en&#39;</span><span class="p">:</span>
        <span class="n">set_lang</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">PluginImplementations</span><span class="p">(</span><span class="n">ITranslation</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">plugin</span><span class="o">.</span><span class="n">i18n_locales</span><span class="p">():</span>
            <span class="n">_add_extra_translations</span><span class="p">(</span><span class="n">plugin</span><span class="o">.</span><span class="n">i18n_directory</span><span class="p">(),</span> <span class="n">lang</span><span class="p">,</span> <span class="n">plugin</span><span class="o">.</span><span class="n">i18n_domain</span><span class="p">())</span>

    <span class="n">tmpl_context</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">lang</span>
    <span class="k">return</span> <span class="n">lang</span>

<span class="k">def</span> <span class="nf">_add_extra_translations</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">locales</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
    <span class="n">translator</span> <span class="o">=</span> <span class="n">Translations</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dirname</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span> <span class="n">locales</span><span class="o">=</span><span class="n">locales</span><span class="p">,</span>
                                   <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pylons</span><span class="o">.</span><span class="n">translator</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">translator</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># this occurs when an extension has &#39;en&#39; translations that</span>
        <span class="c1"># replace the default strings. As set_lang has not been run,</span>
        <span class="c1"># pylons.translation is the NullTranslation, so we have to</span>
        <span class="c1"># replace the StackedObjectProxy ourselves manually.</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">pylons</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span>
        <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;pylons.pylons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">translator</span> <span class="o">=</span> <span class="n">translator</span>
        <span class="k">if</span> <span class="s1">&#39;paste.registry&#39;</span> <span class="ow">in</span> <span class="n">environ</span><span class="p">:</span>
            <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;paste.registry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pylons</span><span class="o">.</span><span class="n">translator</span><span class="p">,</span> <span class="n">translator</span><span class="p">)</span></code></pre></div>
<p>So simple! When ckan makes a call to <code>set_lang</code>, we pass in the babel <code>Translation</code> class in <code>_set_lang</code>, then when languages are changed in <code>handle_request</code>, we merge all the relevant translations from plugins implementing ITranslation.</p>

<p>There is an edge case for the <code>'en'</code> language. The translation class won&rsquo;t exist yet and pylons will set the <code>NullTranslation</code> class, but we want to allow <code>'en'</code> translations in extensions, this allows users to rename &lsquo;Organizations&rsquo; to whatever they like in their custom instance without changing all the templates!</p>

<p>We do not have worry about permissions of merging files on the server, or making the user provide an extra command. All that is required is for plugin writers to add translations to their extensions and implement <code>ITranslation</code>, making the lives of our users simpler.</p>

<p>In the future, it will be worth exploring allowing extensions to specify strings that they do <em>not</em> want to overwrite in core ckan translations, this will probably be have to be handled in extensions themselves.</p>

<p>Hooray for kwargs and the forward thinking of the original author in the pylons to allow this to happen.</p>
]]></content>
		</item>
		
		<item>
			<title>An Evening With Assembly</title>
			<link>https://the.chuntering.dev/posts/an-evening-with-assembly/</link>
			<pubDate>Fri, 14 Aug 2015 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/an-evening-with-assembly/</guid>
			<description>Back when I was young child, my brothers and I used to play a game called Moonstone. So it was with a bit of nostalgic glee that I went about spending a few hours or so in evening poking around the innards of the game. I wish I had bothered to take a look at the time, as I managed to remove the unbelievably long, unskippable intro that the game has, which would of saved my brothers and I a few hours of pain, enduring the intro whilst waiting for the game to start.</description>
			<content type="html"><![CDATA[<p>Back when I was young child, my brothers and I used to play a game called <a href="https://en.wikipedia.org/wiki/Moonstone:_A_Hard_Days_Knight" target="_blank">Moonstone</a>. So it was with a bit of nostalgic glee that I went about spending a few hours or so in evening poking around the innards of the game. I wish I had bothered to take a look at the time, as I managed to remove the <a href="https://www.youtube.com/watch?v=n0rrm5RXHyI" target="_blank">unbelievably long, unskippable intro</a> that the game has, which would of saved my brothers and I a few hours of pain, enduring the intro whilst waiting for the game to start.</p>

<p>You can find the game itself on various abandonware sites and it runs fine in DOSBox. The game comes with three executables, MS.EXE (the executable to play the game), INTR.EXE (the executable that runs the intro sequence) and MAIN.EXE (the main game itself). DOSBox has a <a href="http://www.vogons.org/viewtopic.php?t=7323" target="_blank">debugger build</a> that allows you to examine memory, step through execution, set breakpoints and more. There&rsquo;s a <a href="http://www.vogons.org/viewtopic.php?t=3944" target="_blank">guide</a> to help you along.</p>

<p>The freeware version of IDA, thankfully supports dos exes, so I could open up all three to have a poke around.</p>

<figure>
    <img src="/ida.png"/> <figcaption>
            <h4>MS.EXE in IDA</h4>
        </figcaption>
</figure>


<p>IDA will attempt to identify all the subroutines and possible strings in the exe. Armed with this and the DOSBox debugger, I went through the assembly and spent the next few hours figuring out and labelling all the subroutines, which you should be able to see a few of in the &ldquo;Names&rdquo; list in the screenshot. It was once everything was labelled and much easier to read that it occurred to me that it would be a good idea to get rid of the intro.</p>

<p>For the most part, MS.EXE will do a bit of checking to see if there is enough memory, checking the dos version is compatible and setting up the graphics to <a href="https://en.wikipedia.org/wiki/Mode_13h" target="_blank">mode 13h</a>. After this it&rsquo;ll launch INTR.EXE followed by MAIN.EXE, hopefully you can see this in the screen shot, for example, <code>runIntroAndMain</code> will load <code>0x00be</code> into the dx register before calling <code>executeBinary</code>. You&rsquo;ll notice that <code>0x0be</code> corresponds to the &ldquo;MAIN.EXE&rdquo; string in the strings window. Also notice that in <code>runIntroAndMain</code>, it&rsquo;ll load <code>0x00b5</code> (the INTR.EXE) string, followed by a series of nop instructions. This is where I had replaced the call to <code>executeBinary</code> with a <a href="https://en.wikipedia.org/wiki/NOP_slide" target="_blank">nop slide</a>, thus saving my future self the pain of the intro ever again.</p>

<p>I took a look at INTR.EXE, just out of interest and IDA gave me a warning that it might be packed. For my purposes, I&rsquo;m not interested in the figuring out how to decompress the data myself, but in the hexedit view there were a couple of strings that might indicate how it had been compressed. With a bit of searching, the &ldquo;Packed file is corrupt&rdquo; message, led me to this page informing me it had been packed with EXEPACK. A bit more searching led me to an old UNPACK.EXE that would unpack the fille, I ran this in DOSBox on INTR.EXE and could now analyze it in IDA. I really didn&rsquo;t want to do any unnecessary work if I didn&rsquo;t have to. After, firing up the modified MS.EXE to make sure it worked, I had a quick play for a bit of nostalgia (I think I got more satisfaction from getting rid of the intro than playing the game) before deciding to call it a day and go for some tea.</p>

<p>Next time I take a look at this, I&rsquo;ll take a deeper look at MAIN.EXE and perhaps examine the other file formats.</p>
]]></content>
		</item>
		
		<item>
			<title>Randomising Traitor Numbers in Trouble in Terrorist Town</title>
			<link>https://the.chuntering.dev/posts/random-traitor-numbers-in-trouble-in-terrorist-town/</link>
			<pubDate>Fri, 10 Jul 2015 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/random-traitor-numbers-in-trouble-in-terrorist-town/</guid>
			<description>A while back a group of friends and I went through a spate of playing TTT(Trouble in Terrorist Town), to the point where we ended up playing during that Christmas day post dinner lull.
For me, TTT scratches the traitor game mechanic that you can find in board games like The Resistance, Battlestar Galactica and Shadows Over Camelot which you don&amp;rsquo;t really get in any other computer game. Unlike these games, the number of traitors is rigidly defined by the total number of players by a formula.</description>
			<content type="html"><![CDATA[<p>A while back a group of friends and I went through a spate of playing TTT(Trouble in Terrorist Town), to the point where we ended up playing during that Christmas day post dinner lull.</p>

<p>For me, TTT scratches the traitor game mechanic that you can find in board games like The Resistance, Battlestar Galactica and Shadows Over Camelot which you don&rsquo;t really get in any other computer game. Unlike these games, the number of traitors is rigidly defined by the total number of players by a formula.</p>
<div class="highlight"><pre class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="kr">function</span> <span class="nf">GetTraitorCount</span><span class="p">(</span><span class="n">ply_count</span><span class="p">)</span>
   <span class="c1">-- get number of traitors: pct of players rounded down</span>
   <span class="kd">local</span> <span class="n">traitor_count</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">(</span><span class="n">ply_count</span> <span class="o">*</span> <span class="n">GetConVar</span><span class="p">(</span><span class="s2">&#34;ttt_traitor_pct&#34;</span><span class="p">):</span><span class="n">GetFloat</span><span class="p">())</span>
   <span class="c1">-- make sure there is at least 1 traitor</span>
   <span class="n">traitor_count</span> <span class="o">=</span> <span class="n">math.Clamp</span><span class="p">(</span><span class="n">traitor_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GetConVar</span><span class="p">(</span><span class="s2">&#34;ttt_traitor_max&#34;</span><span class="p">):</span><span class="n">GetInt</span><span class="p">())</span>

   <span class="kr">return</span> <span class="n">traitor_count</span>
<span class="kr">end</span></code></pre></div>
<p>This means that for a given number of players, the number of traitors/innocents is the same each round. This is probably ok for the public servers, but if you&rsquo;re playing within a small set of friends, knowing that there is two traitors every round gets stale quite quickly. So I ended up quickly writing some (bad) code that adds a second variable <code>ttt_traitor_pct_max</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-lua" data-lang="lua"><span class="n">CreateConVar</span><span class="p">(</span><span class="s2">&#34;ttt_traitor_pct_max&#34;</span><span class="p">,</span> <span class="s2">&#34;0.5&#34;</span><span class="p">)</span>

<span class="kd">local</span> <span class="kr">function</span> <span class="nf">GetTraitorCount</span><span class="p">(</span><span class="n">ply_count</span><span class="p">)</span>
    <span class="c1">-- get the difference between ttt_traitor_pct and traitor_pct_max as a positive real number</span>
    <span class="kd">local</span> <span class="n">traitor_pct_range</span> <span class="o">=</span> <span class="n">math.abs</span><span class="p">((</span><span class="n">GetConVar</span><span class="p">(</span><span class="s2">&#34;ttt_traitor_pct_max&#34;</span><span class="p">):</span><span class="n">GetFloat</span><span class="p">()</span> <span class="o">-</span> <span class="n">GetConVar</span><span class="p">(</span><span class="s1">&#39;ttt_traitor_pct&#39;</span><span class="p">):</span><span class="n">GetFloat</span><span class="p">())</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="c1">-- choose a random value in the traitor percentage range</span>
    <span class="kd">local</span> <span class="n">traitor_random</span> <span class="o">=</span> <span class="p">(</span><span class="n">math.random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">traitor_pct_range</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="c1">-- get number of traitors: pct of players rounded down (with our additional random traitors)</span>
    <span class="kd">local</span> <span class="n">traitor_count</span> <span class="o">=</span> <span class="n">math.floor</span><span class="p">(</span><span class="n">ply_count</span> <span class="o">*</span> <span class="p">(</span><span class="n">GetConVar</span><span class="p">(</span><span class="s2">&#34;ttt_traitor_pct&#34;</span><span class="p">):</span><span class="n">GetFloat</span><span class="p">()</span> <span class="o">+</span> <span class="n">traitor_random</span><span class="p">))</span>
    <span class="c1">-- make sure there is at least 1 traitor</span>
    <span class="n">traitor_count</span> <span class="o">=</span> <span class="n">math.Clamp</span><span class="p">(</span><span class="n">traitor_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GetConVar</span><span class="p">(</span><span class="s2">&#34;ttt_traitor_max&#34;</span><span class="p">):</span><span class="n">GetInt</span><span class="p">())</span>
    <span class="kr">return</span> <span class="n">traitor_count</span>
<span class="kr">end</span></code></pre></div>
<p>The number of traitors is then a random percentage between 20 percent and 50 percent of the number of players. This leaves you guessing about the number of traitors every round. If you set it high enough you can have rounds where there is only one innocent and if all the traitors play along, you can end up stringing along the one innocent for as long as possible.</p>

<p>This could probably be improved by having the percentage of traitors function to be heavily right skew instead of being totally random between the two percentages as in above code snippet, thus making a large number of traitors less likely so you end up with generally one less or one more traitor every round with only the occasional large percentage of traitors. This is the main reason I haven&rsquo;t opened a pull request with this change to the garry&rsquo;s mod repo</p>

<p>I do think this will probably only work amongst a group of friends that you know. If you are doing that however, you&rsquo;ll probably want to turn on the <a href="http://ttt.badking.net/config-and-commands/convars#TOC-Karma" target="_blank">karma system</a>and turn off auto kicking and banning (they&rsquo;re you&rsquo;re friends after all). With no kicking/banning you&rsquo;ll need to give people an incentive to not kill people at random. Generally I do this by turning on the strict karma system(<code>ttt_karma_strict</code>) and upping the amount of karma damage each kill does(<code>ttt_karma_kill_penalty</code>). This means that people who regularly team kill end up doing very little damage until their karma recovers and end up dying in a straight up shoot out, even if they shoot first.</p>

<p>I keep the (vaguely up to date) version of init.lua with these changes at here <a href="https://gist.github.com/joetsoi/7266280" target="_blank">https://gist.github.com/joetsoi/7266280</a>
edit: I&rsquo;ve now have a fork which I&rsquo;ve applied these changes to <a href="https://github.com/joetsoi/garrysmod" target="_blank">https://github.com/joetsoi/garrysmod</a>.</p>

<p>Happy traitoring!</p>
]]></content>
		</item>
		
		<item>
			<title>Digging into python memory issues in ckan with heapy</title>
			<link>https://the.chuntering.dev/posts/debugging-python-ckan-memory-issues/</link>
			<pubDate>Mon, 01 Jun 2015 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/debugging-python-ckan-memory-issues/</guid>
			<description>So we had a report about a memory leak when using the ckan datastore extension, where large queries to the datastore would leak large amounts of memory per request. It wasn&amp;rsquo;t simple to get to the bottom of it, at first I couldn&amp;rsquo;t recreate it the leak at all. The test data I was using was the STAR experiment csv files, which I found when I googled &amp;lsquo;Large example csv files&amp;rsquo;.</description>
			<content type="html"><![CDATA[

<p>So we had a report about a memory leak when using the ckan datastore extension, where large queries to the datastore would leak large amounts of memory per request. It wasn&rsquo;t simple to get to the bottom of it, at first I couldn&rsquo;t recreate it the leak at all. The test data I was using was the <a href="https://sdm.lbl.gov/fastbit/data/samples.html" target="_blank">STAR experiment</a> csv files, which I found when I googled &lsquo;Large example csv files&rsquo;. The reporter Alice Heaton, had kindly written a script that would recreate the leak. Even with this, I could not recreate the problem, until I upped the number of rows fetched by a factor of ten. I suspect that Alice has more data per column with perhaps large text fields instead of the mainly numeric data of the STAR experiment data I was using.</p>

<p>Once I could reliably recreate the problem, I ended up poking around using <a href="http://guppy-pe.sourceforge.net/" target="_blank">heapy</a>, which I&rsquo;ve used previously to track down similar problems and inserted some code to setup heapy and an ipdb breakpoint.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">guppy</span> <span class="kn">import</span> <span class="n">hpy</span>
<span class="n">hp</span> <span class="o">=</span> <span class="n">hpy</span><span class="p">()</span>
<span class="n">heap</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">heap</span><span class="p">()</span>
<span class="n">strings</span> <span class="o">=</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span></code></pre></div>
<p>before the <a href="https://github.com/ckan/ckan/blob/release-v2.3/ckan/controllers/api.py#L248" target="_blank">controller returns the result from the api.</a></p>

<p>There are some tutorials hanging around for <a href="http://smira.ru/wp-content/uploads/2011/08/heapy.html" target="_blank">heapy</a>, so I won&rsquo;t repeat the detail, but It looked like the previous responses were hanging around in memory and they were the root cause of the problem.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">heap</span><span class="o">.</span><span class="n">byrcs</span>  
 <span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">343689</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">266893568</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span> <span class="n">Count</span>  <span class="o">%</span>   <span class="n">Size</span>  <span class="o">%</span> <span class="n">Cumulative</span> <span class="o">%</span> <span class="n">Referrers</span> <span class="n">by</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/ </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>  
    <span class="mi">0</span>   <span class="mi">19</span>  <span class="mi">0</span> <span class="mi">190780624</span> <span class="mi">71</span> <span class="mi">190780624</span> <span class="mi">71</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span>  
    <span class="mi">1</span>   <span class="mi">11</span>  <span class="mi">0</span> <span class="mi">21199320</span>  <span class="mi">8</span> <span class="mi">211979944</span> <span class="mi">79</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span><span class="p">,</span> <span class="nb">list</span>  
    <span class="mi">2</span> <span class="mi">107194</span> <span class="mi">31</span> <span class="mi">10007816</span>  <span class="mi">4</span> <span class="mi">221987760</span> <span class="mi">83</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span>  
    <span class="mi">3</span> <span class="mi">41823</span> <span class="mi">12</span> <span class="mi">4018400</span>  <span class="mi">2</span> <span class="mi">226006160</span> <span class="mi">85</span> <span class="nb">tuple</span>  
    <span class="mi">4</span> <span class="mi">24904</span>  <span class="mi">7</span> <span class="mi">3071408</span>  <span class="mi">1</span> <span class="mi">229077568</span> <span class="mi">86</span> <span class="n">function</span>  
    <span class="mi">5</span>  <span class="mi">9287</span>  <span class="mi">3</span> <span class="mi">2350432</span>  <span class="mi">1</span> <span class="mi">231428000</span> <span class="mi">87</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">module</span>  
    <span class="mi">6</span>  <span class="mi">6440</span>  <span class="mi">2</span> <span class="mi">2324560</span>  <span class="mi">1</span> <span class="mi">233752560</span> <span class="mi">88</span> <span class="n">function</span><span class="p">,</span> <span class="nb">tuple</span>  
    <span class="mi">7</span>  <span class="mi">7144</span>  <span class="mi">2</span> <span class="mi">2229040</span>  <span class="mi">1</span> <span class="mi">235981600</span> <span class="mi">88</span> <span class="nb">type</span>  
    <span class="mi">8</span> <span class="mi">15536</span>  <span class="mi">5</span> <span class="mi">1949840</span>  <span class="mi">1</span> <span class="mi">237931440</span> <span class="mi">89</span> <span class="nb">dict</span> <span class="n">of</span> <span class="nb">type</span>  
    <span class="mi">9</span> <span class="mi">19440</span>  <span class="mi">6</span> <span class="mi">1858816</span>  <span class="mi">1</span> <span class="mi">239790256</span> <span class="mi">90</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>  
 <span class="n">Partition</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">set</span> <span class="n">of</span> <span class="mi">343689</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">266892800</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span> <span class="n">Count</span>  <span class="o">%</span>   <span class="n">Size</span>  <span class="o">%</span> <span class="n">Cumulative</span> <span class="o">%</span> <span class="n">Kind</span> <span class="p">(</span><span class="k">class</span> <span class="err">/ </span><span class="nc">dict</span> <span class="n">of</span> <span class="n">class</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">137776</span> <span class="mi">40</span> <span class="mi">225205640</span> <span class="mi">84</span> <span class="mi">225205640</span> <span class="mi">84</span> <span class="nb">str</span>  
    <span class="mi">1</span> <span class="mi">83479</span> <span class="mi">24</span> <span class="mi">7054200</span>  <span class="mi">3</span> <span class="mi">232259840</span> <span class="mi">87</span> <span class="nb">tuple</span>  
    <span class="mi">2</span>  <span class="mi">8486</span>  <span class="mi">2</span> <span class="mi">4350608</span>  <span class="mi">2</span> <span class="mi">236610448</span> <span class="mi">89</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">)</span>  
    <span class="mi">3</span> <span class="mi">18988</span>  <span class="mi">6</span> <span class="mi">2430464</span>  <span class="mi">1</span> <span class="mi">239040912</span> <span class="mi">90</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span>  
    <span class="mi">4</span> <span class="mi">19980</span>  <span class="mi">6</span> <span class="mi">2397600</span>  <span class="mi">1</span> <span class="mi">241438512</span> <span class="mi">90</span> <span class="n">function</span>  
    <span class="mi">5</span>  <span class="mi">842</span>  <span class="mi">0</span> <span class="mi">2387696</span>  <span class="mi">1</span> <span class="mi">243826208</span> <span class="mi">91</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">module</span>  
    <span class="mi">6</span>  <span class="mi">2190</span>  <span class="mi">1</span> <span class="mi">1984280</span>  <span class="mi">1</span> <span class="mi">245810488</span> <span class="mi">92</span> <span class="nb">type</span>  
    <span class="mi">7</span>  <span class="mi">2190</span>  <span class="mi">1</span> <span class="mi">1815888</span>  <span class="mi">1</span> <span class="mi">247626376</span> <span class="mi">93</span> <span class="nb">dict</span> <span class="n">of</span> <span class="nb">type</span>  
    <span class="mi">8</span>  <span class="mi">9956</span>  <span class="mi">3</span> <span class="mi">1585184</span>  <span class="mi">1</span> <span class="mi">249211560</span> <span class="mi">93</span> <span class="nb">list</span>  
    <span class="mi">9</span>  <span class="mi">2563</span>  <span class="mi">1</span> <span class="mi">1509984</span>  <span class="mi">1</span> <span class="mi">250721544</span> <span class="mi">94</span> <span class="nb">unicode</span>  </code></pre></div>
<p>By inspecting those response strings using byid I could see that specifically the response strings are the problem and from the output below it was clear that the response strings were consuming (in my case) 90 odd percent of the memory that was currently in use by strings. but I didn&rsquo;t really have a good idea as to why they were not getting garbage collected.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">byid</span>  
 <span class="n">Set</span> <span class="n">of</span> <span class="mi">151666</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">226687040</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">1</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">42392032</span> <span class="mf">18.7</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">2</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">63588048</span> <span class="mf">28.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">3</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">84784064</span> <span class="mf">37.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">4</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">105980080</span> <span class="mf">46.8</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">5</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">127176096</span> <span class="mf">56.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">6</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">148372112</span> <span class="mf">65.5</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">7</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">169568128</span> <span class="mf">74.8</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">8</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">190764144</span> <span class="mf">84.2</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  
    <span class="mi">9</span> <span class="mi">21196016</span>  <span class="mf">9.4</span> <span class="mi">211960160</span> <span class="mf">93.5</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...l&#34;: 2173762}}&#39;</span>  </code></pre></div>
<p>I then tried to find what was referencing the strings, perhaps we were holding an extra reference to the request object some where in ckan. Below is the shortest paths of references that heapy can find for the above strings</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">pprint</span><span class="p">([</span><span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">shpaths</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)])</span>  
 <span class="p">[</span> <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x4e56250</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x4e56e50</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x4e565f0</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x4ce2430</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x5433ab0</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;curframe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  
  <span class="mi">1</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;curframe_locals&#39;</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  
  <span class="mi">2</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="n">im_self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;curframe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  
  <span class="mi">3</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">t139785342744320_c_traceobj</span><span class="o">.</span><span class="n">im_self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;curframe_locals&#39;</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x55288f0</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x4ce28d0</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x4ce21f0</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">],</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">hpy</span><span class="p">()</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">i0_modules</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_RequestConfig__shared_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="err">??</span><span class="p">[</span><span class="o">&lt;</span><span class="n">weakref</span><span class="o">...</span><span class="n">x54339b0</span><span class="o">&gt;</span><span class="p">][</span><span class="s1">&#39;environ&#39;</span><span class="p">][</span><span class="s1">&#39;pylons.controller&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_py_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;_body&#39;</span><span class="p">]</span>  </code></pre></div>
<p>So the <code>&quot;_RequestConfig__shared_state'].??[ &lt; weakref...x4e56250&gt;&quot;</code> in suggested that these objects should of been cleaned up once there was no longer a reference to them, a manual <code>gc.collect()</code> didn&rsquo;t seem to do anything and inspecting the <code>RequestConfig</code> <code>shared_state</code> showed it to be a <code>thread.local</code> object.</p>

<p>Using <code>.rp</code> shows a tree of references, so in this case, the str is contained in a dict of <code>pylons.controllers.util.Response</code> and that&rsquo;s contained in 3, dict of <code>pylons.util.PylonsContext</code> and so on and so forth</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="o">...</span>  
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rp</span>  
 <span class="n">Reference</span> <span class="n">Pattern</span> <span class="n">by</span> <span class="o">&lt;</span><span class="p">[</span><span class="nb">dict</span> <span class="n">of</span><span class="p">]</span> <span class="n">class</span><span class="o">&gt;.</span>  
  <span class="mi">0</span><span class="p">:</span> <span class="n">_</span> <span class="o">---</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="nb">id</span> <span class="mh">0x7f21a9792010</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x7f21a9792010</span>  
  <span class="mi">1</span><span class="p">:</span> <span class="n">a</span>   <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span> <span class="mh">0x7f224a002550</span>  
  <span class="mi">2</span><span class="p">:</span> <span class="n">aa</span> <span class="o">----</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">pylons</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span> <span class="mh">0x7f224a002550</span>  
  <span class="mi">3</span><span class="p">:</span> <span class="n">a3</span>    <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PylonsContext</span><span class="p">:</span> <span class="mh">0x7f224a002790</span>  
  <span class="mi">4</span><span class="p">:</span> <span class="n">a4</span> <span class="o">------</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PylonsContext</span><span class="p">:</span> <span class="mh">0x7f224a002790</span>  
  <span class="mi">5</span><span class="p">:</span> <span class="n">a5</span>     <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">AttribSafeContextObj</span><span class="p">:</span> <span class="mh">0x7f224a002ad0</span>  
  <span class="mi">6</span><span class="p">:</span> <span class="n">a6</span> <span class="o">--------</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">AttribSafeContextObj</span><span class="p">:</span> <span class="mh">0x7f224a002ad0</span>  
  <span class="mi">7</span><span class="p">:</span> <span class="n">a7</span>      <span class="p">[</span><span class="o">^</span> <span class="mi">3</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">pylons</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">PylonsContext</span><span class="p">:</span> <span class="mh">0x7f224a002790</span>  
  <span class="mi">8</span><span class="p">:</span> <span class="n">a4b</span> <span class="o">------</span> <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="n">of</span> <span class="n">ckan</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">ApiController</span><span class="p">:</span> <span class="mh">0x7f224a002c10</span>  
  <span class="mi">9</span><span class="p">:</span> <span class="n">a4ba</span>    <span class="p">[</span><span class="o">-</span><span class="p">]</span> <span class="mi">1</span> <span class="n">ckan</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">ApiController</span><span class="p">:</span> <span class="mh">0x7f224a002c10</span>  
 <span class="o">&lt;</span><span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">&#39;_.more&#39;</span> <span class="k">for</span> <span class="n">more</span><span class="o">.&gt;</span>  
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rp</span><span class="o">.</span><span class="n">more</span>  
 <span class="mi">10</span><span class="p">:</span> <span class="n">a4baa</span> <span class="o">------</span> <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="mi">1</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">no</span> <span class="n">owner</span><span class="p">):</span> <span class="mh">0x7f222405ef30</span><span class="o">*</span><span class="mi">50</span>  
 <span class="mi">11</span><span class="p">:</span> <span class="n">a4bab</span>    <span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="mi">1</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ckan</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">ApiController</span> <span class="o">...</span>  </code></pre></div>
<p>At this point, I was moaning about my lack of progress with this problem on #ckan on freenode
So I wanted to see if what we have in memory is exactly the responses that we requested (or was it copying one request over and over? etc)
I ended up tweaking the script a bit and removing the total from the result dict returned by <code>datastore_search</code></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="kn">import</span> <span class="nn">json</span>  
 <span class="kn">import</span> <span class="nn">urllib</span>  
 <span class="kn">import</span> <span class="nn">urllib2</span>  
 <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  
 <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>  
   <span class="n">request_params</span> <span class="o">=</span> <span class="p">{</span>  
     <span class="s1">&#39;resource_id&#39;</span><span class="p">:</span> <span class="s1">&#39;blah&#39;</span><span class="p">,</span>  
     <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  
     <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="mi">100000</span> <span class="o">+</span> <span class="n">i</span>  
   <span class="p">}</span>  
   <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s1">&#39;http://localhost:5000/api/action/datastore_search&#39;</span><span class="p">)</span>  
   <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request_params</span><span class="p">)))</span>  
   <span class="nb">str</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  
   <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>  
   <span class="k">print</span> <span class="nb">str</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>  
   <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
   <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> </code></pre></div>
<p>Not exactly the best code I&rsquo;ve ever written, but it did mean that when we inspected using <code>.byid</code>, the output would look something like</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span>  
 <span class="n">Set</span> <span class="n">of</span> <span class="mi">137776</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">225205640</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21198840</span>  <span class="mf">9.4</span> <span class="mi">21198840</span>  <span class="mf">9.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100013}}&#39;</span>  
    <span class="mi">1</span> <span class="mi">21198632</span>  <span class="mf">9.4</span> <span class="mi">42397472</span> <span class="mf">18.8</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100012}}&#39;</span>  
    <span class="mi">2</span> <span class="mi">21198424</span>  <span class="mf">9.4</span> <span class="mi">63595896</span> <span class="mf">28.2</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100011}}&#39;</span>  
    <span class="mi">3</span> <span class="mi">21198200</span>  <span class="mf">9.4</span> <span class="mi">84794096</span> <span class="mf">37.7</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100010}}&#39;</span>  
    <span class="mi">4</span> <span class="mi">21197976</span>  <span class="mf">9.4</span> <span class="mi">105992072</span> <span class="mf">47.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100009}}&#39;</span>  
    <span class="mi">5</span> <span class="mi">21197768</span>  <span class="mf">9.4</span> <span class="mi">127189840</span> <span class="mf">56.5</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100008}}&#39;</span>  
    <span class="mi">6</span> <span class="mi">21197552</span>  <span class="mf">9.4</span> <span class="mi">148387392</span> <span class="mf">65.9</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100007}}&#39;</span>  
    <span class="mi">7</span> <span class="mi">21197336</span>  <span class="mf">9.4</span> <span class="mi">169584728</span> <span class="mf">75.3</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100006}}&#39;</span>  
    <span class="mi">8</span> <span class="mi">21197120</span>  <span class="mf">9.4</span> <span class="mi">190781848</span> <span class="mf">84.7</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100005}}&#39;</span>  
    <span class="mi">9</span> <span class="mi">21196896</span>  <span class="mf">9.4</span> <span class="mi">211978744</span> <span class="mf">94.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100004}}&#39;</span>  
 <span class="o">&lt;</span><span class="mi">137766</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">&#39;_.more&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.&gt;</span>  </code></pre></div>
<p>This way, I could directly see which of the requests made are in memory, it was clear that we were dealing with the old requests being kept around in memory. I also took a look at the next couple of strings hanging around.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="o">.</span><span class="n">more</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
   <span class="mi">10</span>  <span class="mi">77528</span>  <span class="mf">0.0</span> <span class="mi">212056272</span> <span class="mf">94.2</span> <span class="s1">&#39;============...elease.</span><span class="se">\n\n\n</span><span class="s1">&#39;</span>  
   <span class="mi">11</span>  <span class="mi">30712</span>  <span class="mf">0.0</span> <span class="mi">212086984</span> <span class="mf">94.2</span> <span class="s1">&#39;Provide a re...n</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
   <span class="mi">12</span>  <span class="mi">22352</span>  <span class="mf">0.0</span> <span class="mi">212109336</span> <span class="mf">94.2</span> <span class="s1">&#39;(?&lt;=</span><span class="se">\\</span><span class="s1">()(</span><span class="se">\\</span><span class="s1">*...ng |zero</span><span class="se">\\</span><span class="s1">? )&#39;</span>  
   <span class="mi">13</span>  <span class="mi">18016</span>  <span class="mf">0.0</span> <span class="mi">212127352</span> <span class="mf">94.2</span> <span class="s1">&#39;Return a new....</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
   <span class="mi">14</span>  <span class="mi">13656</span>  <span class="mf">0.0</span> <span class="mi">212141008</span> <span class="mf">94.2</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">.. dialect...stgreSQL.</span><span class="se">\n\n</span><span class="s1">&#39;</span>  
   <span class="mi">15</span>  <span class="mi">12480</span>  <span class="mf">0.0</span> <span class="mi">212153488</span> <span class="mf">94.2</span> <span class="s1">&#39;subprocess -...cess.Popen.</span><span class="se">\n</span><span class="s1">&#39;</span>  
   <span class="mi">16</span>  <span class="mi">12088</span>  <span class="mf">0.0</span> <span class="mi">212165576</span> <span class="mf">94.2</span> <span class="s2">&#34;Create a new...k&#39;``.</span><span class="se">\n\n</span><span class="s2">  &#34;</span>  
   <span class="mi">17</span>  <span class="mi">11088</span>  <span class="mf">0.0</span> <span class="mi">212176664</span> <span class="mf">94.2</span> <span class="s1">&#39;Create a SQL....</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
   <span class="mi">18</span>  <span class="mi">10904</span>  <span class="mf">0.0</span> <span class="mi">212187568</span> <span class="mf">94.2</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Co....</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
   <span class="mi">19</span>  <span class="mi">10504</span>  <span class="mf">0.0</span> <span class="mi">212198072</span> <span class="mf">94.2</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Format...output.</span><span class="se">\n</span><span class="s1">  &#39;</span>  
 <span class="o">&lt;</span><span class="mi">137756</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">&#39;_.more&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.&gt;</span>  </code></pre></div>
<p>At this point, the first requests we made no longer appear in memory, the requests for 100000-100003 don&rsquo;t appear to be in memory.</p>

<p>So by doing some stepping through each request and stopping before the controller returned the response each time, we can see that it maintains a maximum of 10 response strings in memory and the older requests get shuffled off</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">c</span>  
 <span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">15</span> <span class="mi">17</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">57</span><span class="p">,</span><span class="mi">892</span> <span class="n">INFO</span> <span class="p">[</span><span class="n">ckan</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">base</span><span class="p">]</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">action</span><span class="o">/</span><span class="n">datastore_search</span> <span class="n">render</span> <span class="n">time</span> <span class="mf">33.155</span> <span class="n">seconds</span>  
 <span class="o">&gt;</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">joe</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">json_datastore</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ckan</span><span class="o">/</span><span class="n">ckan</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">api</span><span class="o">.</span><span class="n">py</span><span class="p">(</span><span class="mi">82</span><span class="p">)</span><span class="fm">__call__</span><span class="p">()</span>  
    <span class="mi">81</span>       <span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>  
 <span class="o">---&gt;</span> <span class="mi">82</span>     <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;mem {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">20</span><span class="p">]))</span>  
    <span class="mi">83</span>   
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span>  
 <span class="n">Set</span> <span class="n">of</span> <span class="mi">151739</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">226701936</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21199056</span>  <span class="mf">9.4</span> <span class="mi">21199056</span>  <span class="mf">9.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100014}}&#39;</span>  
    <span class="mi">1</span> <span class="mi">21198840</span>  <span class="mf">9.4</span> <span class="mi">42397896</span> <span class="mf">18.7</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100013}}&#39;</span>  
    <span class="mi">2</span> <span class="mi">21198632</span>  <span class="mf">9.4</span> <span class="mi">63596528</span> <span class="mf">28.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100012}}&#39;</span>  
    <span class="mi">3</span> <span class="mi">21198424</span>  <span class="mf">9.4</span> <span class="mi">84794952</span> <span class="mf">37.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100011}}&#39;</span>  
    <span class="mi">4</span> <span class="mi">21198200</span>  <span class="mf">9.4</span> <span class="mi">105993152</span> <span class="mf">46.8</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100010}}&#39;</span>  
    <span class="mi">5</span> <span class="mi">21197976</span>  <span class="mf">9.4</span> <span class="mi">127191128</span> <span class="mf">56.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100009}}&#39;</span>  
    <span class="mi">6</span> <span class="mi">21197768</span>  <span class="mf">9.4</span> <span class="mi">148388896</span> <span class="mf">65.5</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100008}}&#39;</span>  
    <span class="mi">7</span> <span class="mi">21197552</span>  <span class="mf">9.4</span> <span class="mi">169586448</span> <span class="mf">74.8</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100007}}&#39;</span>  
    <span class="mi">8</span> <span class="mi">21197336</span>  <span class="mf">9.4</span> <span class="mi">190783784</span> <span class="mf">84.2</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100006}}&#39;</span>  
    <span class="mi">9</span> <span class="mi">21197120</span>  <span class="mf">9.4</span> <span class="mi">211980904</span> <span class="mf">93.5</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100005}}&#39;</span>  
 <span class="o">&lt;</span><span class="mi">151729</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">&#39;_.more&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.&gt;</span>  </code></pre></div>
<p>100004 has been wiped off. At this point after some discussion on irc, we thought it might be the fact that we&rsquo;re in debug mode, and it&rsquo;s just retaining the last 10 responses and their debugging information. but the problem remained when I set &ldquo;debug = false&rdquo; in my ckan development.ini</p>

<p>The thing is ten is far too perfect a number, we humans deal with numbers in batches of ten, if this was a random occurence, it was unlikely that there would just happen to be ten requests hanging around. It was more likely that the ten requests hanging around were the result of some config setting somewhere, where the default was ten.</p>

<p>I pieced together the weakref, thread.local stuff with <a href="http://pythonpaste.org/paste-httpserver-threadpool.html" target="_blank">http://pythonpaste.org/paste-httpserver-threadpool.html</a> and noticed that the <em>default number of threads for the paste http server is 10</em>. I then tested by changing the <code>threadpool_workers=n</code> in my ckan development.ini, and each time it matched the number of strings that showed up in <code>heap[0].byid</code>.</p>

<p>The other thing to notice is that if I made 10 new requests to api endpoints that return a much smaller response</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="n">Set</span> <span class="n">of</span> <span class="mi">151950</span> <span class="o">&lt;</span><span class="nb">str</span><span class="o">&gt;</span> <span class="n">objects</span><span class="o">.</span> <span class="n">Total</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">78397616</span> <span class="nb">bytes</span><span class="o">.</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
    <span class="mi">0</span> <span class="mi">21199280</span> <span class="mf">27.0</span> <span class="mi">21199280</span> <span class="mf">27.0</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100015}}&#39;</span>  
    <span class="mi">1</span> <span class="mi">21199056</span> <span class="mf">27.0</span> <span class="mi">42398336</span> <span class="mf">54.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100014}}&#39;</span>  
    <span class="mi">2</span> <span class="mi">21198840</span> <span class="mf">27.0</span> <span class="mi">63597176</span> <span class="mf">81.1</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...it&#34;: 100013}}&#39;</span>  
    <span class="mi">3</span>  <span class="mi">77528</span>  <span class="mf">0.1</span> <span class="mi">63674704</span> <span class="mf">81.2</span> <span class="s1">&#39;============...elease.</span><span class="se">\n\n\n</span><span class="s1">&#39;</span>  
    <span class="mi">4</span>  <span class="mi">30712</span>  <span class="mf">0.0</span> <span class="mi">63705416</span> <span class="mf">81.3</span> <span class="s1">&#39;Provide a re...n</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
    <span class="mi">5</span>  <span class="mi">22352</span>  <span class="mf">0.0</span> <span class="mi">63727768</span> <span class="mf">81.3</span> <span class="s1">&#39;(?&lt;=</span><span class="se">\\</span><span class="s1">()(</span><span class="se">\\</span><span class="s1">*...ng |zero</span><span class="se">\\</span><span class="s1">? )&#39;</span>  
    <span class="mi">6</span>  <span class="mi">18016</span>  <span class="mf">0.0</span> <span class="mi">63745784</span> <span class="mf">81.3</span> <span class="s1">&#39;Return a new....</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
    <span class="mi">7</span>  <span class="mi">13656</span>  <span class="mf">0.0</span> <span class="mi">63759440</span> <span class="mf">81.3</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">.. dialect...stgreSQL.</span><span class="se">\n\n</span><span class="s1">&#39;</span>  
    <span class="mi">8</span>  <span class="mi">12480</span>  <span class="mf">0.0</span> <span class="mi">63771920</span> <span class="mf">81.3</span> <span class="s1">&#39;subprocess -...cess.Popen.</span><span class="se">\n</span><span class="s1">&#39;</span>  
    <span class="mi">9</span>  <span class="mi">12088</span>  <span class="mf">0.0</span> <span class="mi">63784008</span> <span class="mf">81.4</span> <span class="s2">&#34;Create a new...k&#39;``.</span><span class="se">\n\n</span><span class="s2">  &#34;</span>  
 <span class="o">&lt;</span><span class="mi">151940</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">&#39;_.more&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.&gt;</span>  
 <span class="n">ipdb</span><span class="o">&gt;</span> <span class="n">strings</span><span class="o">.</span><span class="n">byid</span><span class="o">.</span><span class="n">more</span>  
  <span class="n">Index</span>   <span class="n">Size</span>  <span class="o">%</span>  <span class="n">Cumulative</span> <span class="o">%</span>  <span class="n">Representation</span> <span class="p">(</span><span class="n">limited</span><span class="p">)</span>  
   <span class="mi">10</span>  <span class="mi">11088</span>  <span class="mf">0.0</span> <span class="mi">63795096</span> <span class="mf">81.4</span> <span class="s1">&#39;Create a SQL....</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
   <span class="mi">11</span>  <span class="mi">10904</span>  <span class="mf">0.0</span> <span class="mi">63806000</span> <span class="mf">81.4</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Co....</span><span class="se">\n\n</span><span class="s1">    &#39;</span>  
   <span class="mi">12</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63816584</span> <span class="mf">81.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...facets&#34;: {}}}&#39;</span>  <span class="p">(</span><span class="n">the</span> <span class="n">smaller</span> <span class="n">api</span> <span class="n">responses</span><span class="p">)</span>  
   <span class="mi">13</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63827168</span> <span class="mf">81.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...facets&#34;: {}}}&#39;</span>  
   <span class="mi">14</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63837752</span> <span class="mf">81.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...facets&#34;: {}}}&#39;</span>  
   <span class="mi">15</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63848336</span> <span class="mf">81.4</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...facets&#34;: {}}}&#39;</span>  
   <span class="mi">16</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63858920</span> <span class="mf">81.5</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...facets&#34;: {}}}&#39;</span>  
   <span class="mi">17</span>  <span class="mi">10584</span>  <span class="mf">0.0</span> <span class="mi">63869504</span> <span class="mf">81.5</span> <span class="s1">&#39;{&#34;help&#34;: &#34;ht...facets&#34;: {}}}&#39;</span>  
   <span class="mi">18</span>  <span class="mi">10504</span>  <span class="mf">0.0</span> <span class="mi">63880008</span> <span class="mf">81.5</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Format...output.</span><span class="se">\n</span><span class="s1">  &#39;</span>  
   <span class="mi">19</span>   <span class="mi">9168</span>  <span class="mf">0.0</span> <span class="mi">63889176</span> <span class="mf">81.5</span> <span class="s1">&#39;Represent a ...ents.</span><span class="se">\n\n</span><span class="s1">  &#39;</span>  
 <span class="o">&lt;</span><span class="mi">151930</span> <span class="n">more</span> <span class="n">rows</span><span class="o">.</span> <span class="n">Type</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="s1">&#39;_.more&#39;</span> <span class="n">to</span> <span class="n">view</span><span class="o">.&gt;</span>  </code></pre></div>
<p>you&rsquo;ll see the total size has dropped from 226701936 bytes to 78397616 bytes. But the entire time that I had been debugging, I had also been running</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"> $ watch <span class="s2">&#34;cat /proc/`pgrep paster`/status&#34;</span>  
 ...  
 VmPeak: <span class="m">3497708</span> kB  
 VmSize: <span class="m">3497708</span> kB  
 ...  </code></pre></div>
<p>Which still reports the memory usage the same as when the larger requests were still in memory. This is apparently just the way python works (see <a href="https://groups.google.com/forum/#!topic/celery-users/jVc3I3kPtlw" target="_blank">https://groups.google.com/forum/#!topic/celery-users/jVc3I3kPtlw</a>). If you&rsquo;ve just made a response that took up 500mb of memory, it stands to reason that you might have to do the same again quite soon, so python will hang onto the (virtual) memory. But it&rsquo;s not &lsquo;leaked&rsquo;</p>

<p><a href="http://pylons-webframework.readthedocs.org/en/latest/controllers.html#special-methods" target="_blank">http://pylons-webframework.readthedocs.org/en/latest/controllers.html#special-methods</a>, The next step was to investigate whether it&rsquo;s ok to clear out the string in something like the <strong>after</strong>() method of the controller. I ended up creating some pylons specific cleanup middleware (see <a href="https://github.com/ckan/ckan/pull/2262" target="_blank">https://github.com/ckan/ckan/pull/2262</a>)</p>

<p>Once the response string has been served, this middleware replaces the response string with a dummy one, so the original response can be garbage collected. This was lifted from <a href="https://code.google.com/p/modwsgi/wiki/RegisteringCleanupCode" target="_blank">https://code.google.com/p/modwsgi/wiki/RegisteringCleanupCode</a> This middleware is can be switched on by setting &lsquo;ckan.use_pylons_response_cleanup_middleware = true&rsquo; in your development.ini</p>

<p>So I did a comparison of with and without this enabled. Everyone likes graphs right?</p>

<p><img src="/ckan_memory_usage.png" alt="memory usage" /></p>

<p>Notably, the memory usage still grows with this enabled, but is a bit more stable. I also did some examining of the memory and this memory has been returned to python&rsquo;s free lists but has not been released by the python process. see (<a href="http://effbot.org/pyfaq/why-doesnt-python-release-the-memory-when-i-delete-a-large-object.htm" target="_blank">http://effbot.org/pyfaq/why-doesnt-python-release-the-memory-when-i-delete-a-large-object.htm</a>). So we&rsquo;ll still use up as much memory as there are threads</p>

<p>So the other way around it is to do something like use gunicorn + gevent, although this isn&rsquo;t a fair direct comparison as this is only using one worker process, but I mainly suggest this as you can set worker processes to restart after serving a maximum number of requests (see <a href="http://docs.gunicorn.org/en/develop/configure.html#max-requests" target="_blank">http://docs.gunicorn.org/en/develop/configure.html#max-requests</a>), which would release any memory that the process has been allocated but is not using.</p>

<p>Finally it was noted that we probably shouldn&rsquo;t be building up the entire response in memory before returning it this is because we&rsquo;re using json.dumps for the response string. It would be better if we had an iterator of some form to stream the response back.</p>

<p>If you want to help fix it, take a look at  <a href="https://github.com/ckan/ideas-and-roadmap/issues/128" target="_blank">https://github.com/ckan/ideas-and-roadmap/issues/128</a></p>

<p>Next time I look into a python memory issue, I&rsquo;d like to use meliae (<a href="https://pypi.python.org/pypi/meliae" target="_blank">https://pypi.python.org/pypi/meliae</a>) or some other interesting tools. Anyway that was some fun sleuthing.</p>

<h4 id="heapy-docs">heapy docs</h4>

<ul>
<li><a href="http://guppy-pe.sourceforge.net/heapy-thesis.pdf" target="_blank">http://guppy-pe.sourceforge.net/heapy-thesis.pdf</a></li>
<li><a href="http://smira.ru/wp-content/uploads/2011/08/heapy.html" target="_blank">http://smira.ru/wp-content/uploads/2011/08/heapy.html</a></li>
<li><a href="http://haypo-notes.readthedocs.org/en/latest/heap_fragmentation.html" target="_blank">http://haypo-notes.readthedocs.org/en/latest/heap_fragmentation.html</a></li>
<li><a href="https://chase-seibert.github.io/blog/2013/08/03/diagnosing-memory-leaks-python.html" target="_blank">https://chase-seibert.github.io/blog/2013/08/03/diagnosing-memory-leaks-python.html</a></li>

<li><p><a href="http://forthescience.org/blog/2014/08/16/python-and-memory-fragmentation/" target="_blank">http://forthescience.org/blog/2014/08/16/python-and-memory-fragmentation/</a></p>

<h4 id="weak-references">weak references</h4></li>

<li><p><a href="https://docs.python.org/2/library/weakref.html" target="_blank">https://docs.python.org/2/library/weakref.html</a></p></li>

<li><p><a href="http://pymotw.com/2/weakref/" target="_blank">http://pymotw.com/2/weakref/</a></p>

<h4 id="pylons-docs">pylons docs</h4></li>

<li><p><a href="http://pylons-webframework.readthedocs.org/en/latest/execution.html" target="_blank">http://pylons-webframework.readthedocs.org/en/latest/execution.html</a></p></li>

<li><p><a href="http://pythonpaste.org/paste-httpserver-threadpool.html" target="_blank">http://pythonpaste.org/paste-httpserver-threadpool.html</a></p></li>
</ul>

<p>(This post was constructed from <a href="https://github.com/ckan/ckan/issues/1847" target="_blank">https://github.com/ckan/ckan/issues/1847</a>, <a href="https://github.com/ckan/ckan/pull/2262" target="_blank">https://github.com/ckan/ckan/pull/2262</a>)</p>
]]></content>
		</item>
		
		<item>
			<title>WTF is this context thing in CKAN?</title>
			<link>https://the.chuntering.dev/posts/wtf-is-this-context-thing-in-ckan/</link>
			<pubDate>Tue, 17 Feb 2015 00:00:00 +0000</pubDate>
			
			<guid>https://the.chuntering.dev/posts/wtf-is-this-context-thing-in-ckan/</guid>
			<description>If you&amp;rsquo;ve taken a look at the ckan source code, you&amp;rsquo;ll have come across &amp;lsquo;context&amp;rsquo; as the first parameter in many of the functions. It basically contains all threadlocal information required for a function to execute. It&amp;rsquo;s taken me far too long to understand why they exist and I currently think contexts in their current state are pointless.
I&amp;rsquo;m assuming contexts only contain model, session and user. I get why context exists, it basically comes down to whether</description>
			<content type="html"><![CDATA[<p>If you&rsquo;ve taken a look at the ckan source code, you&rsquo;ll have come across &lsquo;context&rsquo; as the first parameter in many of the functions. It basically contains all threadlocal information required for a function to execute. It&rsquo;s taken me far too long to understand why they exist and I currently think contexts in their current state are pointless.</p>

<p>I&rsquo;m assuming contexts only contain model, session and user. I get why context exists, it basically comes down to whether</p>

<ul>
<li>you prefer passing parameters for the request/session/user around into functions, so that the parameters define exactly what the function needs to execute. If we do this though, these are &lsquo;different&rsquo; to other parameters which is why they&rsquo;ve been seperated into context/data_dict. Your functions do not have to refer to some magical global object to execute.</li>
<li>Or whether you are happy using threadlocals, so that if your logic function, calls another function that calls another, that calls &hellip;, that calls function <code>f</code>, <code>f</code> can easily get the request/session/user by calling the flask <code>g</code> object/pylons <code>g</code> thing to get the user without having to muddy up all the other previous function callers definitions. Your compromise is that you have a magical &lsquo;global&rsquo; object (say <code>model.Session</code>) but you can access it anywhere in the code safely without thinking about it too much.</li>
</ul>

<p>There is no right answer, the guy who wrote flask wrote this <a href="http://www.memonic.com/user/pneff/folder/python/id/1Wg" target="_blank">a blog post detailing his hate for thread locals</a> before he wrote flask, <a href="http://flask.pocoo.org/docs/0.10/design/#thread-locals" target="_blank">where the decision was made to use them</a>, I know that <a href="https://lists.okfn.org/pipermail/ckan-dev/2011-August/001151.html" target="_blank">David R</a> is not a fan of them</p>

<p>The problem I think we have, is that ckan straddles both sides and we end up with a worse, really confusing, solution. Currently in ckan, we use the <a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/contextual.html#contextual-thread-local-sessions" target="_blank">scoped_session, which is a threadlocal based setup for sqlalchemy</a>, So when you pass <code>ckan.model</code> from your extension into an action function, unless theres is some additional voodoo(possibly vdm, i haven&rsquo;t looked at that code), then <code>ckan.model.Session</code> and <code>context['session']</code> are currently always the same. This is incredibly confusing, especially to new ckan developers.</p>

<p>So if <code>context['session']</code> is the current sqlalchemy session, that we&rsquo;re passing around, then why are we passing <code>context['model']</code> around? Well it&rsquo;s all to do with the model code. Take a look at <code>model/package.py</code> and you&rsquo;ll see it using <code>meta.Session.query</code> all over the shop. For example,</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="c1"># ckan/model/package.py</span>

 <span class="kn">import</span> <span class="nn">meta</span>  
 <span class="k">class</span> <span class="nc">Package</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>  
 <span class="o">...</span>   
   <span class="nd">@classmethod</span>  
   <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>  
     <span class="s1">&#39;&#39;&#39;Returns a package object referenced by its id or name.&#39;&#39;&#39;</span>  
     <span class="n">query</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="nb">id</span><span class="o">==</span><span class="n">reference</span><span class="p">)</span>  
     <span class="n">pkg</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  
     <span class="k">if</span> <span class="n">pkg</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>  
       <span class="n">pkg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>  
     <span class="k">return</span> <span class="n">pkg</span>  </code></pre></div>
<p>In much of the logic layer you&rsquo;ll see that all the action functions begin</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="c1"># ckan/logic/action/get.py</span>

<span class="k">def</span> <span class="nf">package_show</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>  
   <span class="n">model</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>  
   <span class="n">session</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
   <span class="n">pkg</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">)</span></code></pre></div>
<p>If we didn&rsquo;t include this line and imported <code>ckan.model</code> in the logic layer and ran <code>model.Package.get('blah')</code>, we&rsquo;d be referring to the threadlocal sqlalchemy session(the &ldquo;global&rdquo; one), not the one we passed through <code>context['model']</code>(even if they are they both refer to the same thing)</p>

<p>So to get round this we pass <code>context['model']</code> into the logic functions and generally have a line <code>model = context['model']</code>. This ensures we&rsquo;ll be referring to the session object that we passed in as a parameter through <code>context</code> throughout the code.</p>

<p>So <code>context['model']</code> is a way of avoiding references to the threadlocal/&ldquo;global&rdquo; <code>model.Session</code> object for the model code.</p>

<p>All callees in ckan extensions usually end up constructing a <code>context</code> and passing it in, many of the extensions I&rsquo;ve written contain.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">def</span> <span class="nf">some_method_in_a_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
   <span class="n">some_stuff</span><span class="p">()</span>  
   <span class="o">...</span>  
   <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Session</span><span class="s1">&#39;, &#39;</span><span class="n">user</span><span class="s1">&#39;: c.user }  </span><span class="err">
</span><span class="err"></span><span class="s1">   data_dict = { &#39;</span><span class="n">some</span><span class="s1">&#39;: stuff }  </span><span class="err">
</span><span class="err"></span><span class="s1">   toolkit.get_action(&#39;</span><span class="n">some_action</span><span class="s1">&#39;)(context, data_dict)  </span></code></pre></div>
<p>In reality it&rsquo;s better to do</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">def</span> <span class="nf">some_method_in_a_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
   <span class="n">some_stuff</span><span class="p">()</span>  
   <span class="o">...</span>  
   <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;some&#39;</span><span class="p">:</span> <span class="n">stuff</span> <span class="p">}</span>  
   <span class="n">toolkit</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="s1">&#39;some_action&#39;</span><span class="p">)(</span><span class="n">data_dict</span><span class="o">=</span><span class="n">data_dict</span><span class="p">)</span>  </code></pre></div>
<p>This is because <code>get_action()</code> will construct a default <code>context</code> for you if you don&rsquo;t specify it. Also because, you as an extension writer, do not care about <code>context</code>. (Also in the future it means we can refactor/remove it more easily without breaking your code!)</p>

<p>Anyway, we&rsquo;ve muddied up our code because I never really understood it, but it&rsquo;s how our extensions are written, so everyone copies our code. I personally think it would be better to pass the session to the model code.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">class</span> <span class="nc">Package</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>  
 <span class="o">...</span>   
   <span class="nd">@classmethod</span>  
   <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>  
     <span class="s1">&#39;&#39;&#39;Returns a package object referenced by its id or name.&#39;&#39;&#39;</span>  
     <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="nb">id</span><span class="o">==</span><span class="n">reference</span><span class="p">)</span>  
     <span class="n">pkg</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  
     <span class="k">if</span> <span class="n">pkg</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>  
       <span class="n">pkg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>  
     <span class="k">return</span> <span class="n">pkg</span>  </code></pre></div>
<p>This way, you would no longer need to pass <code>context['model']</code> because the action functions would end up looking like</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">def</span> <span class="nf">package_show</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>  
   <span class="n">user</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="c1"># if i&#39;m using it</span>
   <span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blah&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">])</span>  </code></pre></div>
<p>Wait, wait, or even better</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">def</span> <span class="nf">package_show</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">some_real_parameters_so_I_know_the_parameters_without_looking_at_the_schema</span><span class="p">):</span>  
   <span class="n">model</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blah&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>  </code></pre></div>
<p>This would clean up tests as well, the way we supply user into the <code>context</code> is a pain in the backside. When you&rsquo;re writing a test using the factories and you&rsquo;re passing a user in as an argument, but you might have been given a <code>user_dict</code> by another action function in a test, so what do you use? the username or the <code>user_dict</code>? The answer is we have magic which takes a stab at figuring it out so the <code>context['user']</code> is setup properly.</p>

<p>The problem is even with <code>context</code>, we&rsquo;re still using all the pylons <code>g</code>, <code>c</code> and whatever else everywhere anyway. So we have the problem of threadlocal objects everywhere in the code, but we still have to pass our session/user everywhere, (but not the request, we use pylons threadlocal request for that). Hence why I say <code>context</code>s in their current state are pointless.</p>

<p>Additionally, how do we supply a validation schema? Currently, this is through the <code>context</code>, but this isn&rsquo;t threadlocal data I hear you say? Well, it&rsquo;d also be wrong to pass the schema through the <code>data_dict</code>, because the schema will be validating the <code>data_dict</code> right? So unless there is some extra code to pop the schema from the <code>data_dict</code>, it was easier just to jam it in the <code>context</code>.</p>

<p>So some of our options could be.</p>

<ul>
<li>Make a <code>context</code> <code>namedtuple</code>, but change its name or properly explain what the hell this thing is in the documentation</li>
<li>Think about whether we want to include request info into the <code>context</code>, I know some actions have <code>context['for_view']</code> for some reason or another.</li>
<li>Get rid of <code>context</code>. This means we&rsquo;d have to have our own <code>ckan.g</code> threadlocal thing (to move off pylons one and onto flask or whatever) that we can place the username/request in. but eww this is gross</li>
<li>Get rid of <code>context.model</code> and <code>context session. Let people use</code>ckan.model<code>and</code>model.session`, I end up having to import both of these into extensions anyway and people won&rsquo;t have to think about context anymore.</li>
<li>Get rid of <code>context['user']</code> by having helper functions <code>get_current_username</code> or something which behind the scenes gets the username from pylons.c.user or whatever(if we ever change to something else)</li>
<li>Model and session should be optional parameters where their default arguments are ckan.model and can.model.session so the caller doesn&rsquo;t have to specify them each time they use an action function.</li>
<li>Continue to make blog posts like these but never have the time to change anything anyway.</li>
</ul>

<p>I&rsquo;m thinking currently that I like helpers get_current_username as it can be mocked out in tests and users of our code won&rsquo;t need to think of this crap and just call toolkit.get_current_username in their code, and I also like just letting them use model.Session because they won&rsquo;t sit their thinking &lsquo;wtf is this context thing&rsquo; whenever they want to call an action function in their extension, but I haven&rsquo;t really thought any of this through fully.</p>

<p>Perhaps the best way is to try and change the action functions so session and user are just passed in as normal parameters but have them default to model.Session?</p>

<p><strong>TL;DR</strong> I&rsquo;m sure I&rsquo;ll change my mind by next month, but generally, we should change context so that it&rsquo;s not baffling to the user. I think by hiding from the user entirely, but we could change it to a namedtuple and documenting what the hell it actually is, or just making them non confusing normal parameters. I&rsquo;m sure in a years time, the state of this will not have changed.</p>

<p>This post is constructed from my posts on <a href="https://github.com/ckan/ideas-and-roadmap/issues/53#issuecomment-74453555" target="_blank">ckan/ideas-and-roadmap#53</a></p>
]]></content>
		</item>
		
	</channel>
</rss>
